<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Persona 5 App (with Full Tycoon Embedded)</title>

  <!-- Persona-style headline font -->
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bar-height: 78px;
      --accent: #ff1c1c;
      --accent-dark: #c70000;
      --ink: #000;
      --paper: #fff;
      --ui-gray: #1a1a1a;
      --ui-gray-2: #2c2c2c;
      --gold: #ffd54a;
      --shadow: 0 6px 0 var(--ink);
      --container-max: 720px;
      --success: #34c759;
      --warn: #ffcc00;
    }

    /* General */
    html, body { height: 100%; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Montserrat, Arial, sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100dvh;
      background: var(--ink);
      overflow-x: hidden;
    }

    /* Halftone Persona-style backdrop for screens */
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      padding-bottom: calc(var(--bar-height) + env(safe-area-inset-bottom));
      padding-top: env(safe-area-inset-top);
      min-height: 100dvh;
      width: 100%;
      overflow-y: auto; /* allow scroll when needed */
      background:
        radial-gradient(circle at 20% 10%, rgba(255,255,255,0.07) 2px, transparent 2px) 0 0/14px 14px,
        radial-gradient(circle at 80% 30%, rgba(255,255,255,0.08) 2px, transparent 2px) 0 0/18px 18px,
        var(--accent-dark);
      outline: 3px solid var(--ink);
      outline-offset: -3px;
    }
    .active { display: flex; }

    /* Hide scrollbar only on the progression screen (still scrollable) */
    #progression-screen { scrollbar-width: none; -ms-overflow-style: none; }
    #progression-screen::-webkit-scrollbar { width: 0; height: 0; }

    /* Persona headline banners */
    h2, h3 {
      font-family: "Bangers", system-ui, sans-serif;
      letter-spacing: 1px;
      margin: 6px 0 12px;
      color: var(--ink);
      background: var(--paper);
      border: 3px solid var(--ink);
      display: inline-block;
      padding: 6px 12px;
      transform: rotate(-2.5deg);
      text-shadow: none;
      box-shadow: var(--shadow);
      font-weight: 900;
    }
    /* Make Weather/Music banner same width */
    .card h3.card-banner { width: 120px; text-align: center; }

    /* Sticker-style cards and panels */
    .card, .weight-card, .todo-card, .settings-section, .progression-section, .inventory-section, .apps-section, .calendar-section, .event-item, .day-event-item {
      background: var(--ui-gray);
      border: 3px solid var(--ink);
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    /* Persona buttons */
    button {
      font-weight: 900;
      text-transform: uppercase;
      color: var(--paper);
      background: var(--ui-gray-2);
      border: 3px solid var(--ink);
      border-radius: 8px;
      padding: 10px 12px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transform: skewX(-4deg);
      transition: transform 0.08s ease, background 0.2s ease;
    }
    button:hover { background: var(--ink); }
    button:active { transform: skewX(-4deg) translateY(2px); box-shadow: 0 4px 0 var(--ink); }

    /* Inputs themed */
    input[type="text"], input[type="time"], input[type="number"], select {
      padding: 10px;
      border: 3px solid var(--ink);
      border-radius: 10px;
      background: #1e1e1e;
      color: #fff;
      font-weight: 900;
      box-shadow: var(--shadow);
    }
    label { font-weight: 900; }

    /* Home Screen */
    #home-screen { width: 100%; }

    .date, .time {
      position: absolute;
      font-family: "Bangers", system-ui, sans-serif;
      font-size: 2.6em;
      letter-spacing: 1px;
      color: var(--paper);
      text-shadow: 4px 4px 0 var(--ink);
      -webkit-text-stroke: 3px var(--ink);
      paint-order: stroke fill;
      z-index: 1;
      font-weight: 900;
    }
    .date { top: calc(10px + env(safe-area-inset-top)); left: 24px; transform: rotate(-8deg); }
    .time { top: calc(10px + env(safe-area-inset-top)); right: 24px; transform: rotate(6deg); }

    main.home-wrap { width: 100%; display: flex; flex-direction: column; align-items: center; }

    /* Most Important (deadline style) */
    .mi-wrap {
      width: calc(100% - 20px);
      max-width: var(--container-max);
      padding: 0 8px;
      margin-top: 86px;
    }
    .most-important {
      position: relative;
      padding: 12px 12px 14px;
      background: var(--paper);
      color: var(--ink);
      border: 4px solid var(--ink);
      border-radius: 12px;
      transform: none;
      box-shadow: var(--shadow);
    }
    .mi-ribbon {
      position: absolute;
      top: -12px;
      left: -12px;
      background: var(--accent);
      color: var(--ink);
      border: 4px solid var(--ink);
      border-radius: 10px;
      padding: 4px 10px;
      font-family: "Bangers", system-ui, sans-serif;
      font-size: 1.1em;
      font-weight: 900;
      transform: rotate(3deg);
      box-shadow: var(--shadow);
    }
    .mi-row {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      margin-left: 90px; /* push content clear of the ribbon */
    }
    .mi-date { display: none; }
    .mi-name { font-weight: 900; overflow-wrap: anywhere; text-align: center; }
    .flair-badge { display: none; }
    .mi-count {
      font-weight: 900;
      border: 3px solid var(--ink);
      border-radius: 8px;
      padding: 6px 10px;
      background: var(--accent);
      color: var(--ink);
      transform: none;
      white-space: nowrap;
    }

    .event-list {
      margin: 12px 10px 0;
      text-align: left;
      width: calc(100% - 20px);
      max-width: var(--container-max);
      padding: 0 8px;
    }

    .event-item {
      margin: 12px 0;
      padding: 12px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      background: #121212;
    }
    .event-date-badge {
      font-weight: 900;
      background: var(--paper);
      color: var(--ink);
      border: 3px solid var(--ink);
      padding: 4px 8px;
      border-radius: 6px;
      min-width: 72px;
      text-align: center;
      white-space: nowrap;
      transform: skewX(-6deg);
    }
    .event-name { font-weight: 900; }
    .event-countdown {
      font-weight: 900;
      background: var(--accent);
      color: var(--ink);
      border: 3px solid var(--ink);
      padding: 4px 8px;
      border-radius: 6px;
      white-space: nowrap;
      transform: skewX(-6deg);
    }

    /* Widgets: side-by-side */
    .widgets {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin: 16px 10px 16px;
      width: calc(100% - 20px);
      max-width: var(--container-max);
      padding: 0 8px;
    }
    @media (max-width: 560px) { .widgets { grid-template-columns: 1fr; } }
    .card { padding: 12px; min-height: 110px; width: 100%; }

    /* Weather */
    #weather-card { display: flex; flex-direction: column; }
    .weather-main { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; }
    .weather-icon { font-size: 1.8em; text-shadow: 2px 2px 0 var(--ink); }
    .weather-info { display: flex; flex-direction: column; gap: 2px; font-weight: 900; }
    .forecast-row {
      margin-top: auto;
      border-top: 3px solid var(--ink);
      padding-top: 8px;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }
    .forecast-icon {
      font-size: 1.4em;
      text-align: center;
      background: var(--paper);
      color: var(--ink);
      border: 3px solid var(--ink);
      border-radius: 10px;
      padding: 4px 0;
      box-shadow: var(--shadow);
    }

    /* Music (ellipsis + optional marquee) */
    .music-main { display: grid; grid-template-columns: 80px 1fr; gap: 12px; align-items: center; }
    .artwork {
      width: 80px; height: 80px;
      border: 3px solid var(--ink); border-radius: 8px;
      background: linear-gradient(135deg, #ff3b30, #ffcc00);
      box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center;
      font-size: 2em; color: var(--paper); text-shadow: 2px 2px 0 var(--ink);
    }
    .track-info { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
    .track-title { font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-title.marquee { overflow: hidden; }
    .track-title.marquee span { display: inline-block; padding-left: 100%; animation: marquee 12s linear infinite; }
    @keyframes marquee { from { transform: translateX(0); } to { transform: translateX(-100%); } }
    .track-artist { opacity: 0.9; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .music-progress { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; margin-top: 6px; }
    .progress-bar { height: 8px; background: var(--ui-gray-2); border: 3px solid var(--ink); border-radius: 8px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #ffd54a, #ff8f00); width: 0%; transition: width 0.3s linear; }
    .progress-times { font-weight: 900; font-size: 0.85em; }
    .music-controls { display: flex; gap: 8px; margin-top: 6px; }
    .ctrl { padding: 6px 10px; border-radius: 10px; background: var(--paper); color: var(--ink); border: 3px solid var(--ink); transform: skewX(-4deg); box-shadow: var(--shadow); }
    .ctrl:hover { background: var(--accent); }

    /* Apps Screen - tidy tiles */
    #apps-screen { width: 100%; padding: 20px; }
    .apps-section { width: calc(100% - 24px); max-width: 820px; padding: 12px; }
    .apps-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-top: 6px; }
    .app-tile {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: var(--ui-gray); border: 3px solid var(--ink); border-radius: 12px;
      padding: 14px 10px; min-height: 84px; user-select: none; box-shadow: var(--shadow);
      cursor: pointer; transform: rotate(-1.2deg); transition: transform 0.08s ease;
    }
    .app-tile:hover { transform: rotate(0deg) translateY(2px); box-shadow: 0 4px 0 var(--ink); }
    .app-tile .icon { font-size: 1.6em; margin-bottom: 4px; text-shadow: 2px 2px 0 var(--ink); }
    .app-tile .label { font-weight: 900; font-size: 0.95em; }

    /* Calendar Screen (compact) */
    #calendar-screen { width: 100%; padding: 12px; }
    .calendar-section { width: calc(100% - 24px); max-width: 820px; position: relative; padding: 10px; }
    .month-navigation { display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 10px 0; gap: 10px; }
    .month-navigation button { padding: 8px 10px; }
    .current-month {
      font-family: "Bangers", system-ui, sans-serif; font-weight: 900; font-size: 1.2em; color: var(--ink);
      background: var(--paper); border: 3px solid var(--ink); padding: 6px 10px; transform: rotate(2deg); box-shadow: var(--shadow);
      flex: 1; text-align: center;
    }
    .calendar-headers { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 4px; width: 100%; }
    .calendar-headers div {
      text-align: center; font-weight: 900; color: var(--ink); background: var(--paper); border: 3px solid var(--ink);
      border-radius: 8px; padding: 3px 0; transform: skewX(-4deg); box-shadow: var(--shadow); font-size: 0.95em;
    }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 4px; text-align: center; }
    .calendar div {
      padding: 10px 4px; background-color: #121212; border: 3px solid var(--ink); border-radius: 8px;
      user-select: none; font-weight: 900; transform: skewX(-4deg); font-size: 0.95em;
    }
    .calendar .day { cursor: pointer; transition: transform 0.05s, background 0.2s; }
    .calendar .day:active { transform: skewX(-4deg) scale(0.98); }
    .calendar .today { background-color: var(--accent); color: var(--ink); }
    .calendar .selected { outline: 3px solid var(--paper); box-shadow: 0 0 0 3px var(--ink) inset; }
    .add-fab {
      position: absolute; top: 6px; right: 6px; width: 48px; height: 48px; border-radius: 10px;
      border: 3px solid var(--ink); background: var(--paper); color: var(--ink);
      font-size: 1.6em; line-height: 0; display: flex; align-items: center; justify-content: center;
      z-index: 5; transform: rotate(-6deg);
    }
    .add-fab:hover { background: var(--accent); }

    /* Day events */
    .day-events { margin-top: 10px; width: 100%; }
    .day-events h3 { font-weight: 900; }
    .day-event-item {
      display: grid; grid-template-columns: auto 1fr auto auto; align-items: center; gap: 10px; padding: 10px; background: #121212; margin-bottom: 8px;
    }
    .day-event-time {
      font-weight: 900; background: var(--paper); color: var(--ink); border: 3px solid var(--ink);
      padding: 4px 8px; border-radius: 6px; min-width: 64px; text-align: center; white-space: nowrap;
      transform: skewX(-6deg);
    }
    .day-event-name { font-weight: 900; }
    .edit-btn { background: var(--ui-gray-2); }
    .delete-btn { background: #b00020; }

    /* Settings Screen */
    #settings-screen { width: 100%; padding: 12px; }
    .settings-section { width: calc(100% - 24px); max-width: 820px; padding: 12px; }
    .setting-item {
      background: #121212; border: 3px solid var(--ink); border-radius: 10px; padding: 12px; margin-bottom: 10px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px; box-shadow: var(--shadow);
    }

    /* Progression Screen - per sketch (left tasks | right star + ranks) */
    #progression-screen { width: 100%; padding: 16px; }
    .progression-section { width: calc(100% - 24px); max-width: 920px; padding: 12px; }

    .title-row { width: 100%; display: flex; flex-direction: column; align-items: flex-start; }
    .title-underline {
      width: 100%; height: 0; border-top: 4px solid var(--paper);
      margin: 6px 0 10px; transform: skewX(-8deg);
    }

    .progress-grid {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 720px) { .progress-grid { grid-template-columns: 1fr; } }

    .left-col, .right-col {
      background: #111;
      border: 3px solid var(--ink);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 12px;
      position: relative;
    }
    .right-col { border-left: 6px solid var(--paper); }

    .daily-list { display: flex; flex-direction: column; gap: 8px; }
    .daily-row {
      display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 10px;
      padding: 8px; background: #1a1a1a; border: 3px solid var(--ink); border-radius: 10px;
    }
    .daily-title { font-weight: 900; }

    .inline-star {
      width: 100%; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;
    }
    .inline-star svg { width: 220px; height: 220px; display: block; cursor: pointer; }

    .stat-list { list-style: none; padding: 0; margin: 6px 0 0; display: flex; flex-direction: column; gap: 8px; }
    .stat-item {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--paper); color: var(--ink); border: 3px solid var(--ink);
      border-radius: 10px; padding: 6px 10px; font-weight: 900;
      transform: rotate(-1.5deg); box-shadow: var(--shadow);
    }

    /* Inventory Screen (SWINGA simplified view + edit mode) */
    #inventory-screen { width: 100%; padding: 16px; }
    .inventory-section { width: calc(100% - 24px); max-width: 920px; padding: 12px; position: relative; }
    .weights-grid { display: flex; flex-direction: column; gap: 12px; width: 100%; }
    .inventory-actions { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 8px; gap: 8px; }
    .weight-card { padding: 12px; }
    .weight-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .weight-title {
      font-family: "Bangers", system-ui, sans-serif;
      font-size: 1.5em;
      font-weight: 900;
      color: var(--ink);
      background: var(--paper);
      border: 3px solid var(--ink);
      border-radius: 8px;
      padding: 4px 10px;
      transform: rotate(-2deg);
      box-shadow: var(--shadow);
    }
    /* Summary view chips */
    .summary-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .count-chip {
      background: var(--paper);
      color: var(--ink);
      border: 3px solid var(--ink);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }
    .count-chip .dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid var(--ink); display: inline-block; }
    .rows { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .row { display: grid; grid-template-columns: auto 1fr auto auto; align-items: center; gap: 10px; padding: 10px; border: 3px solid var(--ink); border-radius: 10px; background: #111; }
    .color-badge { display: inline-flex; align-items: center; gap: 8px; font-weight: 900; min-width: 90px; }
    .dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--ink); display: inline-block; }
    .count-input { width: 90px; padding: 8px; border: 3px solid var(--ink); border-radius: 8px; background: #1e1e1e; color: #fff; text-align: center; font-weight: 900; box-shadow: var(--shadow); }
    .qty-controls { display: inline-flex; gap: 8px; }
    .btn-small { padding: 8px 10px; background: var(--ui-gray-2); border: 3px solid var(--ink); color: #fff; border-radius: 8px; cursor: pointer; font-weight: 900; box-shadow: var(--shadow); transform: skewX(-4deg); }
    .btn-small:hover { background: var(--ink); }

    /* Bottom Menu Bar */
    .menu-bar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      height: calc(var(--bar-height) + env(safe-area-inset-bottom));
      background-color: var(--ui-gray-2);
      display: flex; justify-content: space-around; align-items: center;
      border-top: 3px solid var(--ink);
      z-index: 50;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .menu-icon {
      color: white; text-align: center; cursor: pointer; user-select: none; font-weight: 900;
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      padding: 6px 8px; min-width: 72px; border: 3px solid #fff; border-radius: 12px;
      background: var(--ui-gray); box-shadow: var(--shadow);
      transform: rotate(-1.2deg); transition: transform 0.08s ease, border-color 0.2s ease;
    }
    .menu-icon.active { border-color: var(--accent); }
    .menu-icon:hover { color: #fff; transform: rotate(0deg) translateY(2px); }
    .menu-icon .icon { font-size: 1.4em; line-height: 1; text-shadow: 2px 2px 0 var(--ink); }
    .menu-icon .label { font-size: 0.82em; line-height: 1; }

    /* Modals (Add/Edit Event + Star modal) */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.72);
      display: none; align-items: center; justify-content: center;
      z-index: 60; padding: 20px;
      backdrop-filter: blur(2px);
    }
    .modal {
      background: var(--accent-dark);
      border: 3px solid var(--ink);
      border-radius: 14px;
      width: 100%; max-width: 560px;
      box-shadow: 0 12px 0 var(--ink);
      padding: 14px;
    }
    .modal h3 {
      font-family: "Bangers", system-ui, sans-serif; color: var(--ink); background: var(--paper);
      border: 3px solid var(--ink); padding: 6px 12px; display: inline-block; transform: rotate(-2deg);
      box-shadow: var(--shadow); margin-bottom: 10px; font-weight: 900;
    }
    .modal .field { margin: 10px 0; display: flex; flex-direction: column; gap: 8px; }
    .modal .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .modal .actions { display: flex; gap: 12px; margin-top: 10px; }
    .helper { font-size: 0.9em; opacity: 0.9; }

    /* Persona-style dropdowns (Repeat & Flair) */
    .selector { display: flex; flex-direction: column; gap: 6px; }
    .group-title {
      font-weight: 900; color: var(--ink); background: var(--paper); border: 3px solid var(--ink);
      padding: 4px 8px; display: inline-block; transform: rotate(-2deg); box-shadow: var(--shadow); align-self: flex-start;
    }
    .select-display {
      display: inline-flex; align-items: center; justify-content: space-between; gap: 10px;
      padding: 8px 12px; border: 3px solid var(--ink); border-radius: 12px; background: var(--paper); color: var(--ink);
      font-weight: 900; transform: skewX(-4deg); cursor: pointer; box-shadow: var(--shadow); user-select: none;
    }
    .caret { border: 8px solid transparent; border-top-color: var(--ink); transform: translateY(2px); }
    .menu-panel {
      display: none; background: var(--paper); border: 3px solid var(--ink); border-radius: 12px; box-shadow: var(--shadow);
      padding: 8px; margin-top: 6px; max-height: 240px; overflow: auto;
    }
    .menu-item {
      display: flex; align-items: center; gap: 8px; padding: 8px 10px; border: 3px solid var(--ink); border-radius: 12px;
      background: #fff; color: var(--ink); font-weight: 900; transform: skewX(-4deg); cursor: pointer; margin-bottom: 6px;
    }
    .menu-item:last-child { margin-bottom: 0; }
    .menu-item.active { background: var(--accent); }
    .menu-item .dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--ink); display: inline-block; }
    .menu-sep { border-top: 3px solid var(--ink); margin: 8px 0; }
    .create-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; align-items: center; padding: 6px; }
    .create-row input, .create-row select { padding: 8px; border: 3px solid var(--ink); border-radius: 8px; color: #fff; background: #1e1e1e; font-weight: 900; box-shadow: var(--shadow); }

    /* Tycoon section container (embedded via srcdoc iframe, but still one HTML file) */
    .tycoon-section { width: calc(100% - 24px); max-width: 920px; padding: 12px; }
    #ty-embed-container { position: fixed; inset: 0; width: 100vw; height: 100vh; z-index: 999; background: #000; display: none; }
    #ty-embed-frame { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; background: #000; }
    body.ty-immersive { overflow: hidden; }
  </style>
</head>
<body>
  <!-- Home Screen -->
  <div id="home-screen" class="screen active">
    <header>
      <div class="time" id="time-display">12:00</div>
      <div class="date" id="date-display">DD/MM</div>
    </header>
    <main class="home-wrap">
      <!-- Most Important (deadline style) -->
      <section class="mi-wrap">
        <div id="most-important" class="most-important" style="display:none;">
          <div class="mi-ribbon">Most Important</div>
          <div class="mi-row">
            <div class="mi-date" id="mi-date">--/--</div>
            <div class="mi-name" id="mi-name">—</div>
            <div class="mi-count" id="mi-count">—</div>
          </div>
        </div>
      </section>

      <section class="event-list">
        <h2>Upcoming Events</h2>
        <div id="events-container"></div>
      </section>

      <div class="widgets">
        <div class="card" id="weather-card">
          <h3 class="card-banner">Weather</h3>
          <div class="weather-main">
            <div class="weather-icon" id="weather-icon">⛅</div>
            <div class="weather-info">
              <div id="weather-temp">--°C</div>
            </div>
            <div class="weather-rain" id="weather-rain" style="font-weight:900;">—</div>
          </div>
          <div class="forecast-row" id="forecast-row"></div>
        </div>
        <div class="card" id="music-card">
          <h3 class="card-banner">Music</h3>
          <div class="music-main">
            <div class="artwork" id="music-art">🎵</div>
            <div class="track-info">
              <div class="track-title" id="music-title"><span>—</span></div>
              <div class="track-artist" id="music-artist">—</div>
              <div class="music-progress">
                <div class="progress-bar"><div class="progress-fill" id="music-progress-fill"></div></div>
                <div class="progress-times"><span id="music-time">0:00</span> / <span id="music-dur">0:00</span></div>
              </div>
              <div class="music-controls">
                <button class="ctrl" id="btn-prev">⏮</button>
                <button class="ctrl" id="btn-play">⏸</button>
                <button class="ctrl" id="btn-next">⏭</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Apps Screen -->
  <div id="apps-screen" class="screen">
    <section class="apps-section">
      <h2>Apps</h2>
      <div class="apps-grid">
        <div class="app-tile" onclick="showScreen('settings-screen')">
          <div class="icon">⚙️</div>
          <div class="label">Settings</div>
        </div>
        <div class="app-tile" onclick="showScreen('inventory-screen')">
          <div class="icon">🏏</div>
          <div class="label">SWINGA</div>
        </div>
        <div class="app-tile" onclick="showScreen('home-screen')">
          <div class="icon">🏠</div>
          <div class="label">Home</div>
        </div>
        <div class="app-tile" onclick="showScreen('calendar-screen')">
          <div class="icon">📅</div>
          <div class="label">Calendar</div>
        </div>
        <div class="app-tile" onclick="showScreen('progression-screen')">
          <div class="icon">🃏</div>
          <div class="label">Progression</div>
        </div>
        <div class="app-tile" onclick="showScreen('tycoon-screen'); ty_showTitle();">
          <div class="icon">🂡</div>
          <div class="label">Tycoon</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Calendar Screen -->
  <div id="calendar-screen" class="screen">
    <section class="calendar-section">
      <h2>Calendar</h2>

      <button class="add-fab" title="Add Event" onclick="openAddModal()">+</button>

      <div class="month-navigation">
        <button onclick="changeMonth(-1)">Previous</button>
        <div id="current-month" class="current-month"></div>
        <button onclick="changeMonth(1)">Next</button>
      </div>

      <div class="calendar-headers" aria-hidden="true">
        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
      </div>

      <div class="calendar" id="calendar-grid"></div>

      <div id="day-events-container" class="day-events">
        <h3 style="display:none"></h3>
      </div>
    </section>
  </div>

  <!-- Settings Screen -->
  <div id="settings-screen" class="screen">
    <section class="settings-section">
      <h2>Settings</h2>

      <div class="setting-item">
        <label for="setting-24h">24-hour time</label>
        <input id="setting-24h" type="checkbox" />
      </div>

      <div class="setting-item">
        <label for="setting-theme">Theme (placeholder)</label>
        <select id="setting-theme">
          <option value="persona-red">Persona Red</option>
          <option value="midnight-blue">Midnight Blue</option>
          <option value="emerald-green">Emerald Green</option>
        </select>
      </div>

      <div class="setting-item">
        <label for="setting-reminder">Default reminder (mins)</label>
        <input id="setting-reminder" type="number" min="0" max="120" step="5" value="10" />
      </div>

      <div class="settings-actions">
        <button onclick="saveSettings()">Save</button>
        <button onclick="resetSettings()">Reset</button>
      </div>
    </section>
  </div>

  <!-- Progression Screen -->
  <div id="progression-screen" class="screen">
    <section class="progression-section">
      <div class="title-row">
        <h2>SOCIAL STATS</h2>
        <div class="title-underline"></div>
      </div>

      <div class="progress-grid">
        <div class="left-col">
          <h3>Daily Tasks</h3>
          <div id="daily-list" class="daily-list"></div>
          <div style="margin-top:8px; display:flex; gap:10px;">
            <button onclick="resetDaily()">Reset Today</button>
          </div>
        </div>

        <div class="right-col">
          <div class="inline-star" title="Tap to zoom">
            <svg id="star-inline" viewBox="-240 -240 480 480" aria-label="Social Stats Star"></svg>
          </div>
          <ul class="stat-list">
            <li class="stat-item"><span>Knowledge</span><span id="rank-knowledge">Lv 1</span></li>
            <li class="stat-item"><span>Charm</span><span id="rank-charm">Lv 1</span></li>
            <li class="stat-item"><span>Proficiency</span><span id="rank-proficiency">Lv 1</span></li>
            <li class="stat-item"><span>Kindness</span><span id="rank-kindness">Lv 1</span></li>
            <li class="stat-item"><span>Guts</span><span id="rank-guts">Lv 1</span></li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <!-- Inventory Screen (SWINGA) -->
  <div id="inventory-screen" class="screen">
    <section class="inventory-section">
      <h2>SWINGA</h2>

      <div class="inventory-actions">
        <button id="inventory-toggle" onclick="toggleInventoryMode()">Edit</button>
        <button id="reset-all-edit" style="display:none;" onclick="resetAllStock()">Reset All</button>
      </div>

      <div id="weights-summary" class="weights-grid"></div>
      <div id="weights-grid-edit" class="weights-grid" style="display:none"></div>
    </section>
  </div>

  <!-- Tycoon Screen (embedded full game via single-file srcdoc) -->
  <div id="tycoon-screen" class="screen">
    <div id="ty-embed-container" aria-label="Tycoon Game">
      <iframe id="ty-embed-frame" title="Tycoon"></iframe>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div id="add-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="add-modal-title">
    <div class="modal">
      <h3 id="add-modal-title">Add Event</h3>

      <div class="field">
        <label for="modal-event-name">Event</label>
        <input type="text" id="modal-event-name" placeholder="e.g., Game night" />
      </div>

      <div class="field row">
        <div>
          <label>Date</label>
          <div id="modal-selected-date" class="pill-badge" aria-live="polite">Select a day</div>
        </div>
        <div>
          <label for="modal-event-time">Time</label>
          <input type="time" id="modal-event-time" />
        </div>
      </div>

      <!-- Persona-style dropdowns -->
      <div class="field selector">
        <div class="group-title">Repeat</div>
        <div class="select-display" id="add-recur-display" onclick="toggleMenu('add-recur-menu')">
          <span id="add-recur-text">None</span>
          <span class="caret"></span>
        </div>
        <div class="menu-panel" id="add-recur-menu" role="menu" aria-labelledby="add-recur-display"></div>
      </div>

      <div class="field selector">
        <div class="group-title">Flair</div>
        <div class="select-display" id="add-flair-display" onclick="toggleMenu('add-flair-menu')">
          <span id="add-flair-text">No flair</span>
          <span class="caret"></span>
        </div>
        <div class="menu-panel" id="add-flair-menu" role="menu" aria-labelledby="add-flair-display"></div>
      </div>

      <div class="actions">
        <button onclick="confirmAddEvent()">Add</button>
        <button onclick="closeAddModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div id="edit-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
    <div class="modal">
      <h3 id="edit-modal-title">Edit Event</h3>

      <input type="hidden" id="edit-event-id" />

      <div class="field">
        <label for="edit-event-name">Event</label>
        <input type="text" id="edit-event-name" placeholder="Event Name" />
      </div>

      <div class="field row">
        <div>
          <label>Date</label>
          <div id="edit-selected-date" class="pill-badge" aria-live="polite">Date</div>
        </div>
        <div>
          <label for="edit-event-time">Time</label>
          <input type="time" id="edit-event-time" />
        </div>
      </div>

      <!-- Persona-style dropdowns -->
      <div class="field selector">
        <div class="group-title">Repeat</div>
        <div class="select-display" id="edit-recur-display" onclick="toggleMenu('edit-recur-menu')">
          <span id="edit-recur-text">None</span>
          <span class="caret"></span>
        </div>
        <div class="menu-panel" id="edit-recur-menu" role="menu" aria-labelledby="edit-recur-display"></div>
      </div>

      <div class="field selector">
        <div class="group-title">Flair</div>
        <div class="select-display" id="edit-flair-display" onclick="toggleMenu('edit-flair-menu')">
          <span id="edit-flair-text">No flair</span>
          <span class="caret"></span>
        </div>
        <div class="menu-panel" id="edit-flair-menu" role="menu" aria-labelledby="edit-flair-display"></div>
      </div>

      <div class="actions">
        <button onclick="confirmEditEvent()">Save</button>
        <button onclick="closeEditModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Star Zoom Modal -->
  <div id="star-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="star-modal-title">
    <div class="modal" style="max-width: 720px;">
      <h3 id="star-modal-title">Stats Star</h3>
      <div class="star-wrap" id="star-wrap" style="position:relative;">
        <svg id="star-large" viewBox="-240 -240 480 480" style="width:100%;height:auto;"></svg>
        <div id="chip-large-knowledge" class="pill-badge" style="position:absolute;">Knowledge</div>
        <div id="chip-large-guts" class="pill-badge" style="position:absolute;">Guts</div>
        <div id="chip-large-proficiency" class="pill-badge" style="position:absolute;">Proficiency</div>
        <div id="chip-large-kindness" class="pill-badge" style="position:absolute;">Kindness</div>
        <div id="chip-large-charm" class="pill-badge" style="position:absolute;">Charm</div>
      </div>
      <div class="actions">
        <button onclick="closeStarModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Bottom Menu Bar -->
  <footer class="menu-bar">
    <div class="menu-icon active" data-target="home-screen" onclick="showScreen('home-screen')" title="Home">
      <div class="icon">🏠</div>
      <div class="label">Home</div>
    </div>
    <div class="menu-icon" data-target="calendar-screen" onclick="showScreen('calendar-screen')" title="Calendar">
      <div class="icon">📅</div>
      <div class="label">Calendar</div>
    </div>
    <div class="menu-icon" data-target="progression-screen" onclick="showScreen('progression-screen')" title="Progression">
      <div class="icon">🃏</div>
      <div class="label">Progression</div>
    </div>
    <div class="menu-icon" data-target="inventory-screen" onclick="showScreen('inventory-screen')" title="SWINGA">
      <div class="icon">🏏</div>
      <div class="label">SWINGA</div>
    </div>
    <div class="menu-icon" data-target="apps-screen" onclick="showScreen('apps-screen')" title="Menu">
      <div class="icon">☰</div>
      <div class="label">Menu</div>
    </div>
  </footer>

  <!-- The full standalone Tycoon HTML is included below in a hidden textarea. 
       We inject it as iframe.srcdoc at runtime so this stays ONE file, while preserving the game 1:1. -->
  <textarea id="ty-srcdoc" style="display:none;">
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Tycoon — Persona Style (Standalone)</title>

<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">

<style>
  :root{
    --accent: #ff1c1c;
    --accent-dark: #c70000;
    --ink: #000;
    --paper: #fff;
    --ui-gray: #1a1a1a;
    --ui-gray-2: #2c2c2c;
    --shadow: 0 6px 0 var(--ink);
    --warn: #ffcc00;
    --max: 920px;

    --lb-ar: 16/9;

    /* Leaderboard icon slot anchors (percentages over the board) */
    --s1-x: 18%; --s1-y: 18%; --s1-size: 112px;
    --s2-x: 56%; --s2-y: 44%; --s2-size: 102px;
    --s3-x: 32%; --s3-y: 66%; --s3-size: 102px;
    --s4-x: 45%; --s4-y: 87%; --s4-size: 96px;
  }
  html, body { height: 100%; overflow: hidden; }
  * { box-sizing: border-box; }
  body{
    margin:0;
    font-family: Montserrat, Arial, sans-serif;
    color:#fff;
    min-height:100dvh;
    display:flex;
    align-items: stretch;
    justify-content: center;
    background:
      url('./background/redbg.png') center / cover fixed no-repeat,
      var(--accent-dark);
    outline: 3px solid var(--ink);
    outline-offset: -3px;
  }

  .wrap {
    width: calc(100% - 24px);
    max-width: var(--max);
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Header */
  .title-bar {
    position: relative;
    display:flex; align-items:flex-start; justify-content:flex-end; gap:10px;
    min-height: 72px;
    z-index: 6;
  }
  .logo-img {
    position: absolute;
    left: 6px;
    top: 1px;
    height: 132px;
    width: auto;
    display:block;
    pointer-events: none;
    transform: rotate(-2deg);
    filter: drop-shadow(0 2px 0 var(--ink));
    z-index: 7;
  }

  .controls { display:flex; gap:10px; align-items:center; margin-left: auto; }
  .ctrl-btn {
    font-weight: 900;
    text-transform: uppercase;
    color: var(--paper);
    background: var(--ui-gray-2);
    border: 3px solid var(--ink);
    border-radius: 14px;
    padding: 10px 16px;
    cursor: pointer;
    box-shadow: var(--shadow);
    transform: skewX(-4deg);
    transition: transform 0.08s ease, background 0.2s ease, opacity 0.12s ease;
  }
  .ctrl-btn:hover { background: var(--ink); }
  .ctrl-btn:active { transform: skewX(-4deg) translateY(2px); box-shadow: 0 4px 0 var(--ink); }

  .round-img {
    height: 64px;
    width: auto;
    display:block;
    transform: rotate(-2deg);
    user-select: none;
    pointer-events: none;
    filter: drop-shadow(0 2px 0 var(--ink));
  }

  .table-panel {
    padding: 10px;
    background: #000;
    border: 6px solid #000;
    border-radius: 0;
    box-shadow: var(--shadow);
    position: relative;
    z-index: 5;
  }
  .table-stage {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    border: 6px solid #000;
    border-radius: 0;
    background: #5d5d5d url('./background/starbg.png') center / cover no-repeat;
    color: var(--ink);
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    transition: opacity .2s ease;
  }
  .table-stage.conceal { opacity: 0; pointer-events: none; }
  .pile-cards { position: relative; width: 100%; height: 100%; }

  .trick-badge {
    position: absolute;
    top: 10px; right: 10px;
    display: none;
    align-items: center; gap: 8px;
    background: var(--warn); color: #000; border: 3px solid var(--ink); border-radius: 999px;
    padding: 6px 10px; font-weight: 900;
    z-index: 60;
  }

  .player-role-img {
    position: absolute;
    right: 12px;
    bottom: 12px;
    width: 184px;
    height: auto;
    display: none;
    z-index: 101;
    transform: rotate(-2.5deg);
  }
  @media (max-width: 640px){
    .player-role-img { width: 156px; }
  }

  /* Overlays */
  .eight-overlay, .allpass-overlay, .gameset-overlay, .rev-overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.88);
    display: none; align-items: center; justify-content: center; z-index: 12000; pointer-events:none;
  }
  .eight-overlay img, .allpass-overlay img, .rev-overlay img {
    max-width: 52%;
    max-height: 52%;
    opacity: 0; transform: rotate(-3deg) scale(0.85);
    animation: asset-pop 900ms cubic-bezier(.2,1.1,.2,1) forwards;
  }
  .gameset-overlay img {
    max-width: 82%;
    max-height: 82%;
    opacity: 0; transform: rotate(-3deg) scale(0.85);
    animation: asset-pop 900ms cubic-bezier(.2,1.1,.2,1) forwards;
  }
  @keyframes asset-pop {
    0%   { transform: rotate(-8deg) scale(0.75); opacity: 0; }
    45%  { transform: rotate(-2deg) scale(1.08); opacity: 1; }
    100% { transform: rotate(-3deg) scale(1.00); opacity: 1; }
  }

  /* Opponents */
  .opp-panel { padding: 0; background: transparent; border: 0; box-shadow: none; }
  .opp-strip {
    position: relative;
    height: calc(var(--icon-size, 176px));
    margin-top: clamp(32px, calc(40px + var(--icon-size, 176px) * 0.14), 88px);
  }
  .opp-row {
    position: absolute; top: 0;
    display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center;
    transform: translateX(-50%);
  }
  #opp1-row { left: 25%; }
  #opp2-row { left: 50%; }
  #opp3-row { left: 75%; }

  .opp-left { position: relative; width: var(--icon-size, 176px); height: var(--icon-size, 176px); }
  .opp-icon-img { width:100%; height:100%; object-fit:contain; display:block; }
  .opp-count { display:none !important; }
  .opp-name, .opp-role { display:none !important; }

  .beggar-callout-img{
    position: absolute;
    top: calc(-0.30 * var(--icon-size,176px) - 7px);
    left: calc(-0.28 * var(--icon-size,176px) - 5px);
    width: calc(var(--icon-size,176px) * 0.90);
    height: calc(var(--icon-size,176px) * 0.90);
    object-fit: contain;
    display:block; /* keep visible; no toggling to avoid flicker */
    z-index: 3;
    transform: rotate(-3deg);
    pointer-events:none;
  }

  /* Hand */
  .handwrap { padding:0; background:transparent !important; border:0 !important; box-shadow:none !important; margin-top:-72px; }
  .handwrap h3 { display:none; }
  .hand { position:relative; height:248px; overflow:visible; padding:2px 4px 6px; }

  .tcard, .pcard {
    border:2px solid var(--ink);
    border-radius:0;
    box-shadow:var(--shadow);
    color:#222;
    background-color: transparent;
  }
  .tcard {
    width:70px; height:104px; position:absolute;
    user-select:none; cursor:pointer; font-weight:900; --r:0deg; --lift:0px;
    transform: rotate(var(--r)) translateY(var(--lift));
    transition: transform .12s ease, filter .08s ease, opacity .08s ease, box-shadow .1s ease;
    background-image: linear-gradient(135deg,#ffffff,#f0f0f0);
    background-size: 100% 100%;
  }
  .tcard .face { text-align:center; line-height:1.1; font-size:14px; }
  .tcard.red { color:#c62828; }
  .tcard.unplayable { filter:brightness(0.62) saturate(0.85); opacity:0.8; }
  .tcard.selected { outline:4px solid var(--accent); --lift:-22px; }
  .tcard.disabled { opacity:0.5; cursor:not-allowed; }

  .pcard {
    position:absolute; width:86px; height:120px; display:flex; align-items:center; justify-content:center;
    user-select:none; pointer-events:none; transform-origin:center center; left:50%; top:50%;
    background-image: linear-gradient(135deg,#ffffff,#f0f0f0);
    background-size: 100% 100%;
  }
  .pcard .face { text-align:center; line-height:1.08; font-weight:900; font-size:18px; }
  .pcard.red { color:#c62828; }
  .pcard.old { filter:brightness(0.75) grayscale(0.2) saturate(0.85); opacity:0.92; }

  .tcard.img-skin, .pcard.img-skin {
    border:2px solid var(--ink) !important;
    box-shadow:var(--shadow);
    background-color:transparent !important;
    background-repeat:no-repeat !important;
    background-size: 100% 100% !important;
    background-position:center !important;
  }

  /* Play/Pass buttons (image skins) */
  .hand-controls{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    display:flex; align-items:center; justify-content:center; gap:12px;
    z-index: 10002;
  }
  .hand-controls button{
    background: transparent; border: 0; box-shadow: none; padding: 0;
    width: 148px; height: 58px;
    background-size: contain; background-repeat: no-repeat; background-position: center;
    font-size: 0; cursor: pointer; transition: transform .08s ease, opacity .12s ease;
  }
  #ty-play-btn{ background-image: url('./assets/Play.png'); }
  #ty-pass-btn{ background-image: url('./assets/Pass.png'); }
  .hand-controls button:hover{ transform: translateY(-1px) scale(1.02); }
  .hand-controls button:active{ transform: translateY(1px) scale(0.98); }
  .hand-controls button[disabled]{ opacity:0.55; cursor:not-allowed; transform:none; }

  /* Modal overlay and Leaderboard */
  .modal-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.72);
    display:none; align-items:center; justify-content:center;
    z-index:12010; padding:0; backdrop-filter: blur(2px);
    overflow:hidden;
  }
  #results-modal.modal-overlay { padding: 0 !important; }

  .modal { background: transparent; border:0; border-radius:0; width:100%; max-width:none; box-shadow:none; padding:0; }

  /* Wrap just centers the board; actions are fixed to bottom */
  #results-modal .lb-wrap {
    width: 100%;
    max-width: none;
    height: 100%;
    display: grid;
    place-items: center;
    padding-bottom: 88px; /* space behind fixed buttons for focus scrolling */
  }

  .lb-board {
    position: relative;
    /* Fallback; JS will hard-set the exact width with !important. */
    width: 85dvw;
    aspect-ratio: var(--lb-ar);
    background: url('./assets/Leaderboard.png') center / contain no-repeat;
    margin: 0 auto;
    flex: 0 0 auto;
    will-change: width;
  }

  /* Actions anchored to the bottom */
  .lb-actions {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: max(12px, env(safe-area-inset-bottom));
    width: 100%;
    display:flex;
    gap:12px;
    justify-content:center;
    padding: 0 12px;
    pointer-events: auto;
    z-index: 12020;
  }

  .lb-slot {
    position: absolute;
    width: var(--size, 86px);
    height: var(--size, 86px);
    left: calc(var(--x) - var(--size, 86px)/2 + var(--dx, 0px));
    top:  calc(var(--y) - var(--size, 86px)/2 + var(--dy, 0px));
    object-fit: contain;
    image-rendering: auto;
    filter: drop-shadow(0 3px 0 var(--ink));
  }
  #lb-slot-1 { --x: var(--s1-x); --y: var(--s1-y); --size: var(--s1-size); --dx: 100px; }
  #lb-slot-2 { --x: var(--s2-x); --y: var(--s2-y); --size: var(--s2-size); --dx: -10px; }
  #lb-slot-3 { --x: var(--s3-x); --y: var(--s3-y); --size: var(--s3-size); --dx: 30px; }
  #lb-slot-4 { --x: var(--s4-x); --y: var(--s4-y); --size: var(--s4-size); --dx: 0px; }

  .lb-score {
    position: absolute;
    font-weight: 900;
    font-size: 22px;
    color: #fff;
    text-shadow:
      -2px -2px 0 var(--ink),
       2px -2px 0 var(--ink),
       2px  2px 0 var(--ink),
       2px  2px 0 var(--ink),
       0px  0px 2px var(--ink);
    white-space: nowrap;
    left: calc(var(--x) + var(--dx, 0px) + var(--size, 86px)/2 + 14px);
    top:  calc(var(--y) + var(--dy, 0px) - 12px);
    transform: translateY(-50%);
    pointer-events: none;
    user-select: none;
  }
  #lb-score-1 { --x: var(--s1-x); --y: var(--s1-y); --size: var(--s1-size); --dx: 100px; }
  #lb-score-2 { --x: var(--s2-x); --y: var(--s2-y); --size: var(--s2-size); --dx: -10px; }
  #lb-score-3 { --x: var(--s3-x); --y: var(--s3-y); --size: var(--s3-size); --dx: 30px; }
  #lb-score-4 { --x: var(--s4-x); --y: var(--s4-y); --size: var(--s4-size); --dx: 0px; }

  /* Dialogue bubble (bottom-left) */
  .dialogue {
    position: absolute; left: 10px; bottom: 10px;
    display: none; align-items: flex-end; gap: 8px; z-index: 1050; pointer-events: none;
  }
  .dialogue.show { display: flex; animation: dlg-in .18s ease-out; }
  @keyframes dlg-in { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .dialogue-icon { width: 56px; height: 56px; object-fit: contain; filter: drop-shadow(0 2px 0 var(--ink)); }
  .dialogue-bubble {
    position: relative; background: var(--paper); color: var(--ink); border: 3px solid var(--ink);
    padding: 6px 10px; border-radius: 12px; font-weight: 900; transform: rotate(-2deg); max-width: 60vw; line-height: 1.15;
  }
  .dialogue-bubble::after {
    content: ""; position: absolute; left: -12px; bottom: 8px; width: 0; height: 0;
    border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 14px solid var(--ink);
  }
  .dialogue-bubble::before {
    content: ""; position: absolute; left: -9px; bottom: 9px; width: 0; height: 0;
    border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-right: 12px solid var(--paper);
    z-index: 1;
  }
  .dialogue-text { font-size: 16px; }

  /* Title screen overlay — uses startbg.png */
  .title-overlay {
    position: fixed; inset: 0;
    display: none;
    align-items: center; justify-content: center;
    z-index: 13000;
    background: url('./background/startbg.png') center / cover no-repeat;
    padding: 24px;
  }
  .title-inner {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 14px;
    transform: rotate(-1.2deg);
  }
  .title-logo {
    width: min(60vw, 540px);
    max-width: 540px;
    height: auto;
    filter: drop-shadow(0 4px 0 var(--ink));
    pointer-events: none;
  }
  .title-start {
    font-family: Montserrat, Arial, sans-serif;
    font-weight: 900;
    font-size: clamp(18px, 3.2vw, 28px);
    text-transform: uppercase;
    color: var(--paper);
    background: var(--ui-gray-2);
    border: 4px solid var(--ink);
    border-radius: 16px;
    padding: 14px 22px;
    cursor: pointer;
    box-shadow: var(--shadow);
    transform: skewX(-4deg);
  }
  .title-start:hover { background: var(--ink); }
  .title-start:active { transform: skewX(-4deg) translateY(2px); box-shadow: 0 4px 0 var(--ink); }

  /* Setup modal grid */
  .pt-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
    justify-items: center;
    width: 100%;
  }
  @media (max-width: 640px){
    .pt-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  @media (max-width: 420px){
    .pt-grid { grid-template-columns: 1fr; }
  }
  .pt-icon-tile {
    width: 100%;
    max-width: 220px;
    aspect-ratio: 1 / 1;
    background: transparent;
    border: 0;
    box-shadow: none;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; position:relative; user-select:none;
  }
  .pt-icon-tile img.img {
    width: 160px; height: 160px; object-fit:contain; display:block; pointer-events:none;
  }
  .pt-icon-tile.sel img.img {
    filter:
      drop-shadow(0 -2px 0 var(--accent)) drop-shadow(0 2px 0 var(--accent))
      drop-shadow(-2px 0 0 var(--accent)) drop-shadow(2px 0 0 var(--accent))
      drop-shadow(-1.5px -1.5px 0 var(--accent)) drop-shadow(1.5px -1.5px 0 var(--accent))
      drop-shadow(-1.5px 1.5px 0 var(--accent)) drop-shadow(1.5px 1.5px 0 var(--accent));
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="title-bar">
      <img class="logo-img" id="app-logo" src="./assets/Tycoon.png" alt="Tycoon">
      <div class="controls">
        <button id="ty-start-btn" class="ctrl-btn" title="Open character select">Start</button>
        <button id="ty-rules-btn" class="ctrl-btn">Rules</button>
        <img id="round-img" class="round-img" alt="Round">
      </div>
    </div>

    <div class="table-panel">
      <div class="table-stage" id="table-stage">
        <div class="pile-cards" id="ty-pile-cards"></div>
        <div class="trick-badge" id="trick-badge">Trick cleared!</div>

        <img id="player-role-img" class="player-role-img" alt="You">

        <!-- Dialogue bubble -->
        <div id="dialogue" class="dialogue" role="status" aria-live="polite">
          <img id="dialogue-icon" class="dialogue-icon" alt="">
          <div class="dialogue-bubble"><span id="dialogue-text" class="dialogue-text"></span></div>
        </div>

        <!-- Overlays -->
        <div class="eight-overlay" id="eight-overlay"><img src="./assets/8Stop.png" alt="8 STOP"></div>
        <div class="allpass-overlay" id="allpass-overlay"><img src="./assets/AllPass.png" alt="ALL PASS"></div>
        <div class="rev-overlay" id="rev-overlay"><img src="./assets/3spadereverse.png" alt="3♠ REVERSAL"></div>
        <div class="gameset-overlay" id="gameset-overlay"><img src="./assets/GameSet.png" alt="GAME SET"></div>
      </div>
    </div>

    <div class="opp-panel">
      <div id="opp-strip" class="opp-strip">
        <div id="opp1-row" class="opp-row">
          <div class="opp-left">
            <img id="opp1-icon" class="opp-icon-img" alt="P1">
            <img id="opp1-role-img" class="beggar-callout-img" alt="Role">
            <div id="opp1-count" class="opp-count">14</div>
          </div>
          <div><span id="opp1-name" class="opp-name">Ryuji</span><span id="opp1-role" class="opp-role"></span></div>
        </div>
        <div id="opp2-row" class="opp-row">
          <div class="opp-left">
            <img id="opp2-icon" class="opp-icon-img" alt="P2">
            <img id="opp2-role-img" class="beggar-callout-img" alt="Role">
            <div id="opp2-count" class="opp-count">14</div>
          </div>
          <div><span id="opp2-name" class="opp-name">Makoto</span><span id="opp2-role" class="opp-role"></span></div>
        </div>
        <div id="opp3-row" class="opp-row">
          <div class="opp-left">
            <img id="opp3-icon" class="opp-icon-img" alt="P3">
            <img id="opp3-role-img" class="beggar-callout-img" alt="Role">
            <div id="opp3-count" class="opp-count">14</div>
          </div>
          <div><span id="opp3-name" class="opp-name">Yusuke</span><span id="opp3-role" class="opp-role"></span></div>
        </div>
      </div>
    </div>

    <div class="handwrap">
      <h3>Hand</h3>
      <div id="ty-hand" class="hand"></div>
      <div class="hand-controls" aria-label="Actions">
        <button id="ty-play-btn" aria-label="Play">Play</button>
        <button id="ty-pass-btn" aria-label="Pass">Pass</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="results-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="results-title">
    <div class="modal">
      <div class="lb-wrap">
        <div id="lb-board" class="lb-board" aria-label="Leaderboard">
          <img id="lb-slot-1" class="lb-slot" alt="1st">
          <img id="lb-slot-2" class="lb-slot" alt="2nd">
          <img id="lb-slot-3" class="lb-slot" alt="3rd">
          <img id="lb-slot-4" class="lb-slot" alt="4th">
          <div id="lb-score-1" class="lb-score">0 pts</div>
          <div id="lb-score-2" class="lb-score">0 pts</div>
          <div id="lb-score-3" class="lb-score">0 pts</div>
          <div id="lb-score-4" class="lb-score">0 pts</div>
        </div>
        <div class="lb-actions">
          <button id="btn-proceed" class="ctrl-btn">Next Round</button>
          <button id="btn-new-match" class="ctrl-btn" style="display:none;">New Match</button>
          <button id="btn-close-lb" class="ctrl-btn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Setup Modal -->
  <div id="setup-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="setup-title">
    <div class="modal" style="max-width: 620px;">
      <h3 id="setup-title" style="font-family:'Bangers',system-ui,sans-serif;margin:0 0 8px;color:var(--ink);background:var(--paper);border:3px solid var(--ink);display:inline-block;padding:6px 12px;transform:rotate(-2.5deg);box-shadow:var(--shadow);">Choose 3 Opponents</h3>
      <div class="helper" style="margin-bottom:6px;">Select exactly three Phantom Thieves.</div>
      <div id="pt-grid" class="pt-grid"></div>
      <div class="actions" style="display:flex;gap:12px;margin-top:10px;"><button id="setup-begin" class="ctrl-btn" disabled>Begin</button></div>
    </div>
  </div>

  <!-- Rules Modal -->
  <div id="rules-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="rules-title">
    <div class="modal" style="max-width: 620px;">
      <h3 id="rules-title" style="font-family:'Bangers',system-ui,sans-serif;margin:0 0 8px;color:var(--ink);background:var(--paper);border:3px solid var(--ink);display:inline-block;padding:6px 12px;transform:rotate(-2.5deg);box-shadow:var(--shadow);">Rules (Simplified)</h3>
      <div class="rules-body" style="background:#111;padding:10px;border:3px solid var(--ink);">
        Start with any rank (the holder of 3♦ goes first). On your turn, either:
        - Play the same number of cards (single/pair/triple/quad) of a higher rank than the current set, or
        - Pass.
        When all other players pass, the trick clears and the last player to play starts the next trick.
        First player out wins. Rank order (low→high): 3 4 5 6 7 8 9 10 J Q K A 2 Joker.
        Special rules:
        - 8 Stop — playing any 8 clears the trick immediately and the same player starts a new trick.
        - All Pass — when everyone else passes, a new trick begins (overlay shows just before the new trick).
        - Joker — wild; the highest. A single Joker can be beaten by a single 3♠ immediately after it (“3 of spades reversal”).
      </div>
      <div class="actions" style="display:flex;gap:12px;margin-top:10px;">
        <button id="rules-close" class="ctrl-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Title screen -->
  <div id="title-screen" class="title-overlay" role="dialog" aria-modal="true" aria-label="Title">
    <div class="title-inner">
      <img class="title-logo" src="./assets/Tycoon.png" alt="Tycoon">
      <button id="title-start-btn" class="title-start">Start</button>
    </div>
  </div>

<script>
/* ES5-only JS — this is your stable build (mechanics intact). */

function toArray(nl){ return Array.prototype.slice.call(nl || [], 0); }

/* Icon mapping (+ Player) */
window.CUSTOM_ICONS = {
  Ryuji:   "./img/Ryuji.png",
  Ann:     "./img/Ann.png",
  Makoto:  "./img/Makoto.png",
  Futaba:  "./img/Futaba.png",
  Yusuke:  "./img/Yusuke.png",
  Haru:    "./img/Haru.png",
  Akechi:  "./img/Akechi.png",
  Sumire:  "./img/Sumire.png",
  Morgana: "./img/Morgana.png",
  Skull:   "./img/Ryuji.png",
  Panther: "./img/Ann.png",
  Queen:   "./img/Makoto.png",
  Oracle:  "./img/Futaba.png",
  Fox:     "./img/Yusuke.png",
  Noir:    "./img/Haru.png",
  Crow:    "./img/Akechi.png",
  Violet:  "./img/Sumire.png",
  Mona:    "./img/Morgana.png",
  Player:  "./img/Player.png"
};

/* Preload callouts and core assets */
(function(){
  var roles = ['beggar','com','rich','poor','tyc','pbeg','pcom','prich','ppoor','ptyc'];
  for (var i=0;i<roles.length;i++){
    for (var n=0;n<=14;n++){
      var im=new Image(); im.src='./ranks/'+roles[i]+n+'.png';
    }
  }
  var assets = ['8Stop.png','AllPass.png','GameSet.png','Tycoon.png','Round1.png','Round2.png','Round3.png','Play.png','Pass.png','Leaderboard.png','3spadereverse.png'];
  for (var j=0;j<assets.length;j++){ var im2=new Image(); im2.src='./assets/'+assets[j]; }
  var map = window.CUSTOM_ICONS || {};
  for (var k in map){ if (Object.prototype.hasOwnProperty.call(map,k)){ var im3=new Image(); im3.src = map[k]; } }
  var imJ=new Image(); imJ.src='./cards/joker.png';
})();

/* Opponent pool */
var PHANTOM_THIEVES = [
  { key:'Skull', code:'Skull', label:'Ryuji' },
  { key:'Panther', code:'Panther', label:'Ann' },
  { key:'Mona', code:'Mona', label:'Morgana' },
  { key:'Fox', code:'Fox', label:'Yusuke' },
  { key:'Queen', code:'Queen', label:'Makoto' },
  { key:'Oracle', code:'Oracle', label:'Futaba' },
  { key:'Noir', code:'Noir', label:'Haru' },
  { key:'Crow', code:'Crow', label:'Akechi' },
  { key:'Violet', code:'Violet', label:'Sumire' }
];

function setIcon(imgEl, name){
  var map = window.CUSTOM_ICONS || {};
  var url = map[name] || '';
  if (imgEl && url){
    if (imgEl.src !== url) imgEl.src = url;
    imgEl.alt = name || '';
  } else if (imgEl){
    imgEl.removeAttribute('src'); imgEl.alt = name || '';
  }
}

/* Cards imagery */
var CARD_IMG_BASE = './cards';
function mapFileStem(rank){
  var face = { J:'Jack', Q:'Queen', K:'King' };
  if (rank === 'A') return '1';
  if (rank === '10') return '10';
  if (rank === 'JOKER') return 'joker';
  if (face[rank]) return face[rank];
  var n = parseInt(rank, 10);
  if (!isNaN(n) && n >= 2 && n <= 9) return String(n);
  return null;
}
function getCardImageURL(card){
  if (card.rank === 'JOKER') return CARD_IMG_BASE + '/joker.png';
  var stem = mapFileStem(card.rank);
  if (!stem) return null;
  if (card.suit === '♣') return CARD_IMG_BASE + '/' + stem + 'Club.png';
  if (card.suit === '♦') return CARD_IMG_BASE + '/' + stem + 'Diamond.png';
  if (card.suit === '♥') return CARD_IMG_BASE + '/' + stem + 'Heart.png';
  if (card.suit === '♠') return CARD_IMG_BASE + '/' + stem + 'Spade.png';
  return null;
}
function applyCardTexture(el, card){
  var url = getCardImageURL(card);
  if (url){
    el.classList.add('img-skin');
    el.innerHTML = '';
    el.style.backgroundImage = "url('"+url+"')";
  } else {
    el.classList.remove('img-skin');
    el.style.backgroundImage = '';
  }
}

/* Game constants */
var TY_RANKS = ['3','4','5','6','7','8','9','10','J','Q','K','A','2','JOKER'];
var TY_VALUES = (function(){
  var o={}, base=3; for (var i=0;i<TY_RANKS.length;i++){ o[TY_RANKS[i]] = base + i; } return o;
})();
var TY_SUITS = ['♣','♦','♥','♠'];
var RANK_NAMES = ['Tycoon','Rich','Poor','Beggar'];
var RANK_POINTS = [30,20,10,0];

var EIGHT_STOP_DELAY = 1600;
var ALL_PASS_DELAY  = 1000;
var BOT_TURN_DELAY  = 1200;
var REVERSAL_DELAY  = 1300;

var HAND_CARD_W = 70, HAND_CARD_H = 104, HAND_HEIGHT = 248, HAND_TOP_MARGIN = 8, HAND_BOTTOM_MARGIN = 10;

var match = { totalRounds: 3, roundsPlayed: 0, points: [0,0,0,0] };

/* State */
var ty = {
  deck: [], hands: [[],[],[],[]],
  finished: [false,false,false,false],
  finishOrder: [], lastAction: ['','','',''], lastCards: [[],[],[],[]],
  currentRoles: {},
  botNames: ['Ryuji','Makoto','Yusuke'],
  pile: { rank:null, count:0, by:null, cards: [] },
  pileHistory: [],
  passSet: [false,false,false,false],
  turn: 0,
  selectedIds: {}, selectedRank: null,
  started: false, endingRound: false, _timer: null, _watch: null, _endTimer: null,
  _inEightStop: false,
  _resolvingAllPass: false
};

/* DOM refs */
var el = {
  rulesBtn: document.getElementById('ty-rules-btn'),
  startBtn: document.getElementById('ty-start-btn'),
  titleScreen: document.getElementById('title-screen'),
  titleStartBtn: document.getElementById('title-start-btn'),

  playBtn: document.getElementById('ty-play-btn'),
  passBtn: document.getElementById('ty-pass-btn'),
  tableStage: document.getElementById('table-stage'),
  pileCards: document.getElementById('ty-pile-cards'),
  trickBadge: document.getElementById('trick-badge'),
  eightOverlay: document.getElementById('eight-overlay'),
  allPassOverlay: document.getElementById('allpass-overlay'),
  revOverlay: document.getElementById('rev-overlay'),
  resultsModal: document.getElementById('results-modal'),
  setupModal: document.getElementById('setup-modal'),
  rulesModal: document.getElementById('rules-modal'),
  playerRoleImg: document.getElementById('player-role-img'),

  oppStrip: document.getElementById('opp-strip'),
  oppRows: [document.getElementById('opp1-row'), document.getElementById('opp2-row'), document.getElementById('opp3-row')],
  opp: [
    { icon: document.getElementById('opp1-icon'), name: document.getElementById('opp1-name'), role: document.getElementById('opp1-role'), count: document.getElementById('opp1-count'), roleImg: document.getElementById('opp1-role-img') },
    { icon: document.getElementById('opp2-icon'), name: document.getElementById('opp2-name'), role: document.getElementById('opp2-role'), count: document.getElementById('opp2-count'), roleImg: document.getElementById('opp2-role-img') },
    { icon: document.getElementById('opp3-icon'), name: document.getElementById('opp3-name'), role: document.getElementById('opp3-role'), count: document.getElementById('opp3-count'), roleImg: document.getElementById('opp3-role-img') }
  ],

  hand: document.getElementById('ty-hand'),
  resultsBoard: document.getElementById('lb-board'),
  lbSlots: [
    document.getElementById('lb-slot-1'),
    document.getElementById('lb-slot-2'),
    document.getElementById('lb-slot-3'),
    document.getElementById('lb-slot-4')
  ],
  lbScores: [
    document.getElementById('lb-score-1'),
    document.getElementById('lb-score-2'),
    document.getElementById('lb-score-3'),
    document.getElementById('lb-score-4')
  ],
  proceedBtn: document.getElementById('btn-proceed'),
  newMatchBtn: document.getElementById('btn-new-match'),
  closeLbBtn: document.getElementById('btn-close-lb'),
  roundImg: document.getElementById('round-img'),
  ptGrid: document.getElementById('pt-grid'),
  setupBegin: document.getElementById('setup-begin'),
  rulesClose: document.getElementById('rules-close'),

  dlgRoot: document.getElementById('dialogue'),
  dlgIcon: document.getElementById('dialogue-icon'),
  dlgText: document.getElementById('dialogue-text')
};

/* Helpers */
function buildDeck(){
  var i=0, d=[];
  for(var ri=0; ri<TY_RANKS.length-1; ri++){
    for(var si=0; si<TY_SUITS.length; si++){
      d.push({ id:String(i++), rank:TY_RANKS[ri], suit:TY_SUITS[si], value:TY_VALUES[TY_RANKS[ri]] });
    }
  }
  for (var j=0;j<4;j++){ d.push({ id:String(i++), rank:'JOKER', suit:'🃏', value:TY_VALUES['JOKER'] }); }
  return d;
}
function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j = Math.random()*(i+1)|0; var t=a[i]; a[i]=a[j]; a[j]=t; } }
function nextAlive(from){ var idx=from; for(var step=0; step<4; step++){ idx=(idx+1)%4; if(!ty.finished[idx]) return idx; } return 0; }
function isRoundOver(){
  if(ty.finishOrder.length>=3){
    if(ty.finishOrder.length===3){
      for(var p=0;p<4;p++){ if(ty.finishOrder.indexOf(p)===-1){ ty.finishOrder.push(p); break; } }
    }
    return true;
  }
  return false;
}

/* Callout asset helpers */
function clamp14(n){ n = n|0; if(n<0) return 0; if(n>14) return 14; return n; }
function roleKeyForOpponent(role){ var r=(role||'').toLowerCase(); if(r==='tycoon') return 'tyc'; if(r==='rich') return 'rich'; if(r==='poor') return 'poor'; if(r==='beggar') return 'beggar'; return 'com'; }
function roleKeyForPlayer(role){ var r=(role||'').toLowerCase(); if(r==='tycoon') return 'ptyc'; if(r==='rich') return 'prich'; if(r==='poor') return 'ppoor'; if(r==='beggar') return 'pbeg'; return 'pcom'; }
function opponentRoleAsset(role, count){ return './ranks/' + roleKeyForOpponent(role) + clamp14(count) + '.png'; }
function playerRoleAsset(role, count){ return './ranks/' + roleKeyForPlayer(role) + clamp14(count) + '.png'; }

function isJoker(c){ return c && c.rank==='JOKER'; }
function isThreeOfSpades(c){ return c && c.rank==='3' && c.suit==='♠'; }

/* Dialogue helpers */
function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
var BOT_DIALOG = {
  Ryuji: { pass:["Pass.","Yeah, I got nothing.","Nope.","I can't work with that.","Okay, moving on.","Unbelievable.","What, again?","How many of those you got?"], play1:["Okay, this one.","I'm playing this.","Here we go.","How's that?","You like them apples?","There you go.","Get a load of this.","Kaboom.","Gotcha.","Let's rock.","Let's do this."], playN:["How about a pair?","Here comes a pair.","Three card combo.","Okay, three cards.","I'm going for it.","We're locked in.","Can you beat this?"], eight:["Here's an eight stop.","Flushin' this—8 Stop! My turn!","Flushing and starting again."] },
  Ann: { pass:["I'll pass.","No thanks.","Not this time."], play1:["I'll play this.","Going with this.","This should do."], playN:["How about a set?","Let's raise it.","Make it a combo."], eight:["8 Stop! Fashionably clean.","Cut! 8 Stop.","Reset with 8!"] },
  Makoto: { pass:["I'll pass.","Pass—strategically.","Skipping this turn."], play1:["Playing this.","Proceed.","Deploying."], playN:["Set confirmed.","Raising the count.","Acknowledged."], eight:["8 Stop. New trick begins.","Rule invoked: 8 Stop.","Resetting with 8."] },
  Yusuke: { pass:["I shall pass.","Not my stroke.","I will refrain."], play1:["A singular play.","Elegant.","Observe."], playN:["A bold composition.","Behold.","A study in rhythm."], eight:["8 Stop—cleansed.","A fresh canvas with 8.","Art demands reset: 8!"] },
  Futaba: { pass:["Pass.","Nope.","Skipping!"], play1:["EZ clap.","Dropping this.","Pog."], playN:["Mega drop!","Buffed combo!","Deploying set."], eight:["8 Stop! System purge!","Rebooting the trick: 8!","Hard reset with 8!"] },
  Morgana: { pass:["Pass.","I'm sitting out.","Not now."], play1:["Try this, meow.","Playing this.","How about this?"], playN:["Take this set!","Combo time!","Stacked up!"], eight:["8 Stop! Nya!","Clean sweep—8!","Reset with 8!"] },
  Haru: { pass:["I'll pass.","Not quite yet.","I'll wait."], play1:["Gentle but firm.","Playing this.","How about that?"], playN:["A lovely set.","Let's make it a combo.","Serving a stack."], eight:["8 Stop—fresh start.","Time for tea—8 stop.","Resetting with 8."] },
  Akechi: { pass:["Pass.","Not worth it.","I'll bide my time."], play1:["Simple.","Playing this.","Try me."], playN:["Check.","Raising.","Let's see it."], eight:["8 Stop. Your move.","Reset—8.","Board wiped with 8."] },
  Sumire: { pass:["I'll pass.","Sitting out.","Not this turn!"], play1:["I can do this!","Playing this!","Here I go!"], playN:["Let's go—combo!","Stacking up!","Believe it!"], eight:["8 Stop! Reset!","Eight stop—nice!","New start with 8!"] }
};
function botLinePlay(name, count){ var d=BOT_DIALOG[name]||{}; var pool=(count===1?d.play1:d.playN)||[]; return pool.length?randPick(pool):(count===1?"Playing this.":"Set—let's go."); }
function botLinePass(name){ var d=BOT_DIALOG[name]||{}; var pool=d.pass||[]; return pool.length?randPick(pool):"I'll pass."; }
function botLineEight(name){ var d=BOT_DIALOG[name]||{}; var pool=d.eight||[]; return pool.length?randPick(pool):"8 Stop!"; }

/* Dialogue */
function showDialogue(name, text, ms){
  if(!el.dlgRoot) return;
  setIcon(el.dlgIcon, name);
  el.dlgText.textContent = text || '';
  el.dlgRoot.classList.add('show');
  clearTimeout(showDialogue._t);
  showDialogue._t = setTimeout(function(){ el.dlgRoot.classList.remove('show'); }, ms || 1500);
}

/* Pass tracking */
function passClear(){ ty.passSet = [false,false,false,false]; }
function passAdd(p){ ty.passSet[p]=true; }

/* Everyone else passed? */
function everyoneElsePassed(){
  if(ty.pile.count===0 || ty.pile.by==null) return false;
  var aliveOthers=0, passed=0;
  for(var p=0;p<4;p++){
    if(ty.finished[p]) continue;
    if(p!==ty.pile.by){ aliveOthers++; if(ty.passSet[p]) passed++; }
  }
  return aliveOthers>0 && passed===aliveOthers;
}

/* All Pass resolution (guarded) */
function resolveAllPassIfNeeded(){
  if(ty._resolvingAllPass) return true;
  if(!everyoneElsePassed()) return false;

  ty._resolvingAllPass = true;
  el.allPassOverlay.style.display='flex';
  var starter = ty.pile.by;
  setTimeout(function(){
    el.allPassOverlay.style.display='none';
    ty.pile={rank:null,count:0,by:null,cards:[]};
    ty.pileHistory=[];
    passClear();
    ty.turn = (!ty.finished[starter]) ? starter : nextAlive(starter);
    ty._resolvingAllPass = false;
    ty_renderAll();
    if(!isRoundOver()){
      if(ty.turn!==0) ty_queueNextStep(BOT_TURN_DELAY);
      else ty_updateButtons();
    } else {
      scheduleFinishRound();
    }
  }, ALL_PASS_DELAY);

  return true;
}

/* Selection helpers */
function selHas(id){ return !!ty.selectedIds[id]; }
function selAdd(id){ ty.selectedIds[id]=true; }
function selDel(id){ delete ty.selectedIds[id]; }
function selClear(){ ty.selectedIds={}; }
function selCount(){ var n=0; for(var k in ty.selectedIds){ if(ty.selectedIds.hasOwnProperty(k)) n++; } return n; }

function countByRank(cards){
  var m={}; for(var i=0;i<cards.length;i++){ var c=cards[i]; m[c.rank]=(m[c.rank]||0)+1; }
  return m;
}
function getJokers(hand){ var a=[]; for(var i=0;i<hand.length;i++){ if(isJoker(hand[i])) a.push(hand[i]); } return a; }
function getCardsByRank(hand, rank){ var a=[]; for(var i=0;i<hand.length;i++){ if(hand[i].rank===rank) a.push(hand[i]); } return a; }
function findThreeOfSpades(hand){ for(var i=0;i<hand.length;i++){ if(isThreeOfSpades(hand[i])) return hand[i]; } return null; }

function effectiveRankOfSelection(sel){
  for(var i=0;i<sel.length;i++){ if(!isJoker(sel[i])) return sel[i].rank; }
  return 'JOKER';
}

/* UI updaters */
function updateRoundIndicator(){
  var n = Math.min(match.roundsPlayed + 1, match.totalRounds);
  var src = './assets/Round' + n + '.png';
  el.roundImg.src = src; el.roundImg.alt = 'Round ' + n + ' / ' + match.totalRounds;
}

/* Callouts */
function setOpponentRoleImage(oIndex, role, count){
  var img = el.opp[oIndex].roleImg;
  var src = opponentRoleAsset(role, count);
  if (img.getAttribute('data-src') !== src){
    img.setAttribute('data-src', src);
    img.src = src;
    img.alt = (role || 'Commoner') + ' ' + clamp14(count);
  }
}
function updatePlayerRoleImage(){
  var node = el.playerRoleImg;
  var role = (ty.currentRoles && ty.currentRoles[0]) || 'Commoner';
  var c = (ty.hands[0] && ty.hands[0].length) ? ty.hands[0].length : 0;
  var src = playerRoleAsset(role, c);
  if (node.getAttribute('data-src') !== src){
    node.setAttribute('data-src', src);
    node.src = src;
    node.alt = 'You ' + role + ' ' + clamp14(c);
  }
  node.style.display = 'block';
}

function updateOpponentsUI(){
  for(var i=0;i<3;i++){
    var name = ty.botNames[i];
    var handCount = ty.hands[i+1] ? ty.hands[i+1].length : 0;
    var roleTxt = ty.currentRoles ? ty.currentRoles[i+1] : '';
    if (!roleTxt && match.roundsPlayed === 0) roleTxt = 'Commoner';
    setIcon(el.opp[i].icon, name);
    setOpponentRoleImage(i, roleTxt || 'Commoner', handCount);
  }
  updatePlayerRoleImage();
}

function renderPile(currentCards, historySets){
  var cont = el.pileCards; cont.innerHTML = '';
  var hist = (historySets||[]).slice(-5);
  for(var h=0;h<hist.length;h++){ drawSet(hist[h], {old:true,zBase:10+h*10}); }
  drawSet(currentCards||[], {old:false, zBase:1000});
}
function drawSet(cards, opts){
  var old = !!opts.old, zBase = opts.zBase|0;
  var n=cards.length; if(!n) return;
  var maxSpread = n<=1 ? 8 : 32;
  for(var i=0;i<n;i++){
    var c=cards[i]; var d=document.createElement('div');
    d.className='pcard'+((c.suit==='♦'||c.suit==='♥')?' red':'')+(old?' old':'');
    d.innerHTML='<div class="face">'+c.rank+'<br>'+c.suit+'</div>';
    applyCardTexture(d,c);
    var t=i-(n-1)/2; var angle=(n===1)?(Math.random()*10-5):(t*(maxSpread/(n-1)));
    d.style.transform='translate(-50%,-50%) rotate('+angle+'deg)'; d.style.zIndex=String(zBase+i);
    el.pileCards.appendChild(d);
  }
}

/* Layout hand */
function layoutFanHandFlat(){
  var cards = toArray(el.hand.querySelectorAll('.tcard')); var n=cards.length; if(!n) return;
  var boxW = el.hand.clientWidth; var boxH = el.hand.clientHeight;
  var padX=8, cardW=HAND_CARD_W, cardH=HAND_CARD_H;
  var innerW = Math.max(80, boxW - padX*2);
  var spacing = n>1 ? (innerW - cardW) / (n-1) : 0; spacing = Math.max(16, Math.min(46, spacing));
  var usedW = cardW + spacing*(n-1); var startLeft = Math.round((boxW - usedW)/2);
  var maxAngle = Math.max(4, Math.min(10, 18 - Math.floor(n/2)));
  var maxLift  = Math.max(12, Math.min(24, 40 - Math.floor(n)));
  var minBase = HAND_TOP_MARGIN + maxLift; var maxBase = boxH - cardH - HAND_BOTTOM_MARGIN;
  var baseTop = Math.round(boxH * 0.48);
  baseTop = Math.max(minBase, Math.min(maxBase, baseTop));
  var mid=(n-1)/2;
  for(var i=0;i<n;i++){
    var t=(i-mid)/(mid||1); var angle=t*maxAngle; var lift=Math.round((1-Math.abs(t))*maxLift);
    var left=Math.round(startLeft+i*spacing); var top=Math.round(baseTop-lift);
    var card=cards[i];
    if(card.dataset._l!=left){ card.style.left=(card.dataset._l=left)+'px'; }
    if(card.dataset._t!=top){ card.style.top=(card.dataset._t=top)+'px'; }
    card.style.zIndex=String(100+i); card.style.setProperty('--r', angle.toFixed(2)+'deg');
  }
}

/* Buttons + highlight */
function ty_updateButtons(){
  var yourTurn = ty.turn===0 && !ty.finished[0] && ty.started && !isRoundOver();
  el.passBtn.disabled = !(yourTurn && ty.pile.count>0);
  el.playBtn.disabled = !(yourTurn && ty_canPlaySelection());
}

/* Playability highlight */
function ty_highlightPlayable(){
  var yourTurn = ty.turn===0 && !ty.finished[0] && ty.started && !isRoundOver();
  var cards = toArray(document.querySelectorAll('#ty-hand .tcard'));
  for(var i=0;i<cards.length;i++){ cards[i].classList.remove('unplayable'); }
  if(!yourTurn) return;
  if(ty.pile.count===0) return;

  var need = ty.pile.count, minVal = TY_VALUES[ty.pile.rank];
  var hand = ty.hands[0];

  if (ty.pile.rank==='JOKER'){
    for (var i=0;i<cards.length;i++){
      var r = cards[i].dataset.rank, s = cards[i].dataset.suit;
      var allow = (need===1 && r==='3' && s==='♠');
      if (!allow) cards[i].classList.add('unplayable');
    }
    return;
  }

  var counts = countByRank(hand);
  var jokers = getJokers(hand), jokerCount = jokers.length;
  var allowedIds = {};

  if(jokerCount >= need){
    for (var ji=0; ji<jokers.length; ji++) allowedIds[jokers[ji].id]=true;
  }

  for (var ri=0; ri<TY_RANKS.length-1; ri++){
    var rk = TY_RANKS[ri];
    if (TY_VALUES[rk] <= minVal) continue;
    var have = counts[rk]||0;
    if (have + jokerCount >= need){
      for (var i=0;i<hand.length;i++){
        var c = hand[i];
        if (c.rank===rk || isJoker(c)) allowedIds[c.id]=true;
      }
    }
  }

  for(var i=0;i<cards.length;i++){
    var id = cards[i].dataset.id;
    if(!allowedIds[id]) cards[i].classList.add('unplayable');
  }
}

/* Selection and play */
function ty_toggleSelect(card){
  if(ty.turn!==0 || ty.finished[0] || isRoundOver()) return;

  var hand = ty.hands[0];
  var need = ty.pile.count;

  if (ty.pile.count>0 && ty.pile.rank==='JOKER'){
    selClear();
    if (need===1 && isThreeOfSpades(card)){
      selAdd(card.id);
      ty.selectedRank = '3';
    } else {
      ty.selectedRank = null;
    }
    ty_updateButtons(); ty_renderAll();
    return;
  }

  if(ty.pile.count===0){
    if(selHas(card.id)){ selDel(card.id); } else { selAdd(card.id); }
    if(selCount()>4){ selClear(); selAdd(card.id); }
    ty.selectedRank = (selCount()? effectiveRankOfSelection(hand.filter(function(c){return selHas(c.id);})): null);
    ty_updateButtons(); ty_renderAll();
    return;
  }

  selClear();

  var targetRank = isJoker(card) ? null : card.rank;
  var jokers = getJokers(hand);
  var jokerIds = toArray(jokers).map(function(c){return c.id;});
  var picked=0;

  if(targetRank){
    var same = getCardsByRank(hand, targetRank);
    for(var i=0;i<same.length && picked<need;i++){ selAdd(same[i].id); picked++; }
    for(var j=0;j<jokerIds.length && picked<need;j++){ selAdd(jokerIds[j]); picked++; }
    ty.selectedRank = targetRank;
  } else {
    for(var j2=0;j2<jokerIds.length && picked<need;j2++){ selAdd(jokerIds[j2]); picked++; }
    ty.selectedRank = 'JOKER';
  }

  ty_updateButtons(); ty_renderAll();
}

function selectionCards(){
  return ty.hands[0].filter(function(c){ return selHas(c.id); });
}

/* Rules with Jokers and 3♠ reversal */
function ty_canPlaySelection(){
  var sel = selectionCards();
  if(!sel.length) return false;

  var count = sel.length;
  if (count < 1 || count > 4) return false;

  var nonJRank = null;
  for (var i=0;i<sel.length;i++){
    if (!isJoker(sel[i])){
      if (nonJRank === null) nonJRank = sel[i].rank;
      else if (sel[i].rank !== nonJRank) return false;
    }
  }
  var effRank = nonJRank || 'JOKER';

  if(ty.pile.count===0){
    return true;
  }

  if(count !== ty.pile.count) return false;

  if (ty.pile.rank==='JOKER'){
    return (ty.pile.count===1 && count===1 && isThreeOfSpades(sel[0]));
  }

  return TY_VALUES[effRank] > TY_VALUES[ty.pile.rank];
}

function ty_playSelected(){
  if(!ty_canPlaySelection()) return;
  var sel = selectionCards();
  var count=sel.length;

  var ids={}; for(var i=0;i<sel.length;i++){ ids[sel[i].id]=true; }
  ty.hands[0] = ty.hands[0].filter(function(c){ return !ids[c.id]; });

  var wasJoker = (ty.pile.count===1 && ty.pile.rank==='JOKER' && count===1 && isThreeOfSpades(sel[0]));
  var effRank = effectiveRankOfSelection(sel);
  if(wasJoker) effRank='3';

  if(ty.pile.cards && ty.pile.cards.length){
    ty.pileHistory.push(ty.pile.cards.slice(0));
    if(ty.pileHistory.length>5) ty.pileHistory = ty.pileHistory.slice(-5);
  }

  ty.lastAction[0] = wasJoker ? '3♠ reversal!' : ('Played ' + count + (effRank==='JOKER'?' Joker(s)':'× '+effRank));
  ty.lastCards[0] = sel.slice(0);

  ty.pile = { rank: effRank, count: count, by:0, cards: sel.slice(0) };
  passClear();
  selClear(); ty.selectedRank=null;

  if(ty.hands[0].length===0 && !ty.finished[0]){ ty.finished[0]=true; ty.finishOrder.push(0); }

  if(wasJoker && !isRoundOver()){
    threeSpadeReversal(0);
    ty_queueNextStep(REVERSAL_DELAY+220);
    return;
  }

  if(effRank==='8' && !isRoundOver()){
    eightStop(0);
    ty_queueNextStep(EIGHT_STOP_DELAY+220);
    return;
  }
  if(isRoundOver()){ ty_renderAll(); ty_updateButtons(); scheduleFinishRound(); return; }

  ty.turn = nextAlive(0); ty_renderAll();
  ty_queueNextStep(BOT_TURN_DELAY);
}

function ty_pass(){
  if(ty.turn!==0 || ty.pile.count===0) return;
  ty.lastAction[0]='Pass'; ty.lastCards[0]=[]; passAdd(0);

  if(resolveAllPassIfNeeded()){ ty_renderAll(); return; }

  ty.turn=nextAlive(0);
  ty_renderAll();
  if(isRoundOver()){ ty_updateButtons(); scheduleFinishRound(); return; }
  ty_queueNextStep(BOT_TURN_DELAY);
}

/* Clear trick */
function ty_clearTrick(flash){
  if(flash===undefined) flash=false;
  if(ty.pile.count===0) return false;
  var starter=ty.pile.by;
  ty.pile={rank:null,count:0,by:null,cards:[]};
  ty.pileHistory=[];
  passClear();
  ty.turn = (!ty.finished[starter]) ? starter : nextAlive(starter);
  if(flash){
    el.trickBadge.style.display='inline-flex';
    setTimeout(function(){ el.trickBadge.style.display='none'; }, 900);
  }
  return true;
}

/* Eight Stop */
function eightStop(by){
  el.eightOverlay.style.display='flex';
  setTimeout(function(){ el.eightOverlay.style.display='none'; }, EIGHT_STOP_DELAY);
  ty.pile={rank:null,count:0,by:null,cards:[]};
  ty.pileHistory=[]; passClear();
  ty.turn = (!ty.finished[by]) ? by : nextAlive(by);
  ty_renderAll();
}

/* 3♠ Reversal — hard stop, same player starts next trick */
function threeSpadeReversal(by){
  el.revOverlay.style.display='flex';
  setTimeout(function(){ el.revOverlay.style.display='none'; }, REVERSAL_DELAY);
  ty.pile={rank:null,count:0,by:null,cards:[]};
  ty.pileHistory=[]; passClear();
  ty.turn = (!ty.finished[by]) ? by : nextAlive(by);
  ty_renderAll();
}

/* Always-advance watchdog */
function ty_queueNextStep(delay){
  if(delay===undefined) delay=BOT_TURN_DELAY;
  if(ty._timer){ clearTimeout(ty._timer); ty._timer=null; }
  if(ty._watch){ clearTimeout(ty._watch); ty._watch=null; }
  if(!ty.started || isRoundOver() || ty.endingRound) return;
  if(ty.turn!==0 && !ty.finished[ty.turn]){
    ty._timer = setTimeout(function(){
      try { ty_stepTurn(); } catch(e){ if(window.console && console.error){ console.error('stepTurn error', e); } ty_queueNextStep(300); }
    }, delay);
    ty._watch = setTimeout(function(){
      if(!ty.started || isRoundOver() || ty.endingRound) return;
      if(ty.turn!==0 && !ty.finished[ty.turn]){
        ty_queueNextStep(200);
      }
    }, delay + 1000);
  }
}

/* Bot step */
function ty_stepTurn(){
  if(ty._watch){ clearTimeout(ty._watch); ty._watch=null; }
  if(isRoundOver() || !ty.started){ if(isRoundOver()) scheduleFinishRound(); return; }
  var b=ty.turn; if(b===0 || ty.finished[b]){ ty_updateButtons(); return; }

  if(ty.hands[b].length===0){
    ty.finished[b]=true; if(ty.finishOrder.indexOf(b)===-1) ty.finishOrder.push(b);
    ty.turn=nextAlive(b); ty_renderAll();
    if(!isRoundOver() && ty.turn!==0) ty_queueNextStep(Math.max(350,BOT_TURN_DELAY/2)); else if(isRoundOver()) scheduleFinishRound();
    return;
  }

  var botName = botNameForIndex(b);
  var played=false, playedRank=null;

  var need = ty.pile.count;

  if(ty.pile.count===0){
    var playedCard = null;
    for (var ri=0; ri<TY_RANKS.length-1 && !playedCard; ri++){
      var rk = TY_RANKS[ri];
      for (var i=0;i<ty.hands[b].length;i++){ var c=ty.hands[b][i]; if(c.rank===rk){ playedCard=c; break; } }
    }
    if(!playedCard){
      for (var j=0;j<ty.hands[b].length;j++){ if(isJoker(ty.hands[b][j])){ playedCard=ty.hands[b][j]; break; } }
    }
    if(playedCard){
      ty_botPlayExact(b, [playedCard], playedCard.rank);
      played=true; playedRank=playedCard.rank;
      showDialogue(botName, botLinePlay(botName, 1), 1600);
    }
  } else {
    var minVal=TY_VALUES[ty.pile.rank];
    var counts = countByRank(ty.hands[b]);

    if(need===1 && ty.pile.rank==='JOKER'){
      var threeS = null;
      for (var i2=0;i2<ty.hands[b].length;i2++){ if(isThreeOfSpades(ty.hands[b][i2])){ threeS=ty.hands[b][i2]; break; } }
      if(threeS){
        ty_botPlayExact(b, [threeS], '3');
        showDialogue(botName, "3♠ reversal!", 1500);
        threeSpadeReversal(b);
        ty_queueNextStep(REVERSAL_DELAY+220);
        return;
      }
    }

    if(!played){
      if(ty.pile.rank!=='JOKER' && (counts['JOKER']||0) >= need){
        var js=[], k=0;
        for (var j2=0;j2<ty.hands[b].length && k<need;j2++){ if(isJoker(ty.hands[b][j2])){ js.push(ty.hands[b][j2]); k++; } }
        ty_botPlayExact(b, js, 'JOKER');
        played=true; playedRank='JOKER';
        showDialogue(botName, botLinePlay(botName, need), 1600);
      }
    }
    if(!played){
      var candidate=null, best=999;
      for (var ri2=0; ri2<TY_RANKS.length-1; ri2++){
        var r=TY_RANKS[ri2];
        if ((counts[r]||0)>=need && TY_VALUES[r]>minVal && TY_VALUES[r]<best){ best=TY_VALUES[r]; candidate=r; }
      }
      if(candidate){
        var set=[], kk=0;
        for (var i3=0;i3<ty.hands[b].length && kk<need;i3++){ var cc=ty.hands[b][i3]; if(cc.rank===candidate){ set.push(cc); kk++; } }
        ty_botPlayExact(b, set, candidate);
        played=true; playedRank=candidate;
        showDialogue(botName, botLinePlay(botName, need), 1600);
      }
    }
  }

  if(!played){
    passAdd(b);
    showDialogue(botName, botLinePass(botName), 1500);

    if(resolveAllPassIfNeeded()){ ty_renderAll(); return; }

    ty.turn=nextAlive(b);
    ty_renderAll();
    if(!isRoundOver() && ty.turn!==0) ty_queueNextStep(BOT_TURN_DELAY); else if(isRoundOver()) scheduleFinishRound();
  } else {
    if(ty.hands[b].length===0 && ty.finishOrder.indexOf(b)===-1){ ty.finished[b]=true; ty.finishOrder.push(b); }
    if(playedRank==='8' && !isRoundOver()){
      showDialogue(botName, "8 Stop!", 1500);
      eightStop(b);
      ty_queueNextStep(EIGHT_STOP_DELAY+220);
      return;
    }
    if(isRoundOver()){ ty_renderAll(); scheduleFinishRound(); return; }
    ty.turn=nextAlive(b); ty_renderAll();
    if(!isRoundOver() && ty.turn!==0) ty_queueNextStep(BOT_TURN_DELAY); else if(isRoundOver()) scheduleFinishRound();
  }
  ty_updateButtons();
}

function botNameForIndex(bIndex){ return (bIndex>=1 && bIndex<=3) ? ty.botNames[bIndex-1] : 'You'; }

function ty_botPlayExact(botIndex, cards, effRank){
  var idset = {}; for(var i=0;i<cards.length;i++){ idset[cards[i].id]=true; }
  var remain=[]; for (var j=0;j<ty.hands[botIndex].length;j++){ var c=ty.hands[botIndex][j]; if(!idset[c.id]) remain.push(c); }
  if(ty.pile.cards && ty.pile.cards.length){ ty.pileHistory.push(ty.pile.cards.slice(0)); if(ty.pileHistory.length>5) ty.pileHistory=ty.pileHistory.slice(-5); }
  ty.hands[botIndex]=remain;
  ty.pile = { rank: effRank, count: cards.length, by: botIndex, cards: cards.slice(0) };
  passClear();
}

/* Round flow */
function objectHasKeys(o){ if(!o) return false; for(var k in o){ if(o.hasOwnProperty(k)) return true; } return false; }

function startRound(){
  el.tableStage.classList.remove('conceal');
  clearTimeout(ty._endTimer); ty.endingRound = false;

  ty.deck = buildDeck(); shuffle(ty.deck);
  ty.hands = [[],[],[],[]]; ty.finished=[false,false,false,false];
  ty.finishOrder=[]; ty.lastAction=['','','','']; ty.lastCards=[[],[],[],[]];
  ty.pile={rank:null,count:0,by:null,cards:[]}; ty.pileHistory=[]; passClear();
  selClear(); ty.selectedRank=null; ty._inEightStop=false; ty._resolvingAllPass=false;

  var per = Math.floor(ty.deck.length/4);
  for(var i=0;i<per;i++){ for(var p=0;p<4;p++){ ty.hands[p].push(ty.deck[i*4+p]); } }
  for(var pp=0;pp<4;pp++){ ty.hands[pp].sort(function(a,b){ return a.value-b.value || a.suit.localeCompare(b.suit); }); }

  if (match.roundsPlayed === 0 && (!ty.currentRoles || !objectHasKeys(ty.currentRoles))) {
    ty.currentRoles = { 0:'Commoner', 1:'Commoner', 2:'Commoner', 3:'Commoner' };
  }

  ty.turn=0; ty.started=true;

  updateRoundIndicator();
  updateOpponentsUI();
  ty_renderAll(true);
  syncLayout();
  ty_queueNextStep(700);
}
function scheduleFinishRound(){
  if(ty.endingRound) return; ty.endingRound=true; el.tableStage.classList.add('conceal'); el.pileCards.innerHTML='';
  ty._endTimer = setTimeout(finishRoundAndScore, 900);
}
function finishRoundAndScore(){
  if(ty._timer){ clearTimeout(ty._timer); ty._timer=null; }
  if(ty._watch){ clearTimeout(ty._watch); ty._watch=null; }
  ty.currentRoles = {};
  for (var i=0;i<ty.finishOrder.length;i++){ var p=ty.finishOrder[i]; match.points[p] += RANK_POINTS[i]; ty.currentRoles[p] = RANK_NAMES[i]; }
  if (ty.finishOrder.length===3){ for(var last=0; last<4; last++){ if(ty.finishOrder.indexOf(last)===-1){ ty.finishOrder.push(last); break; } } }
  match.roundsPlayed += 1;
  var done = match.roundsPlayed >= match.totalRounds;

  el.tableStage.classList.remove('conceal');

  var g=document.getElementById('gameset-overlay'); g.style.display='flex';
  setTimeout(function(){
    g.style.display='none';
    renderLeaderboardImage();
    el.proceedBtn.style.display = done ? 'none' : 'inline-block';
    el.newMatchBtn.style.display = 'inline-block';
    el.closeLbBtn.style.display = done ? 'none' : 'inline-block';
    openResults();
  }, 1000);
}

/* Leaderboard render */
function renderLeaderboardImage(){
  var entries = [
    { name:'You', idx:0, pts:match.points[0] },
    { name:ty.botNames[0], idx:1, pts:match.points[1] },
    { name:ty.botNames[1], idx:2, pts:match.points[2] },
    { name:ty.botNames[2], idx:3, pts:match.points[3] }
  ];
  entries.sort(function(a,b){ return b.pts-a.pts; });

  for(var i=0;i<4;i++){
    var slot = el.lbSlots[i];
    var label = el.lbScores[i];
    var ent = entries[i];
    if(!slot || !label || !ent) continue;
    var map = window.CUSTOM_ICONS || {};
    slot.src = ent.idx===0 ? './img/Player.png' : (map[ent.name] || '');
    slot.alt = (i+1) + ' — ' + ent.name;
    label.textContent = ent.pts + ' pts';
  }
}

/* Layout */
function syncLayout(){
  var strip = el.oppStrip; var w = (strip && strip.clientWidth) ? strip.clientWidth : window.innerWidth;
  var size = Math.round(w / 7.9);
  size = Math.max(160, Math.min(188, size));
  if (window.innerWidth < 680) size = Math.max(128, Math.min(164, Math.round(w / 8.3)));
  for(var i=0;i<el.opp.length;i++){ var left = el.opp[i].icon.parentElement; if(left) left.style.setProperty('--icon-size', size + 'px'); }
}

/* Setup modal */
function openSetup(){ try{
  hideTitle();
  buildOpponentGrid();
  el.setupBegin.disabled=true;
  el.setupModal.style.display='flex';
  hidePlayerCallout();
} catch(e){ if(window.console && console.error){ console.error('openSetup error', e); } } }
function closeSetup(){ el.setupModal.style.display='none'; }

/* Character select */
function buildOpponentGrid(){
  el.ptGrid.innerHTML='';
  var grid = el.ptGrid;
  for(var i=0;i<PHANTOM_THIEVES.length;i++){
    var p=PHANTOM_THIEVES[i];
    var name=p.label;
    var map=window.CUSTOM_ICONS||{};
    var url=map[name]||'';

    var tile=document.createElement('div');
    tile.className='pt-icon-tile';
    tile.setAttribute('data-name', name);
    tile.tabIndex = 0;

    var img=document.createElement('img');
    img.className='img';
    img.alt=name;
    img.src=url;
    img.onerror = function(){
      this.style.display='none';
      var fb=document.createElement('div');
      fb.textContent=this.alt?this.alt[0]:'?';
      fb.style='font-size:42px;font-weight:900;color:#fff;';
      if(this.parentElement) this.parentElement.appendChild(fb);
    };
    tile.appendChild(img);

    (function(tileRef, gridRef){
      function toggle(){
        if(tileRef.classList.contains('sel')) {
          tileRef.classList.remove('sel');
        } else {
          var sel=toArray(gridRef.querySelectorAll('.pt-icon-tile.sel'));
          if(sel.length>=3) return;
          tileRef.classList.add('sel');
        }
        var count = gridRef.querySelectorAll('.pt-icon-tile.sel').length;
        el.setupBegin.disabled = (count!==3);
      }
      tileRef.addEventListener('click', function(ev){
        ev.preventDefault(); ev.stopPropagation();
        toggle();
      });
      tileRef.addEventListener('keydown', function(ev){
        var k = ev.key || ev.keyCode;
        if(k==='Enter' || k===' ' || k===13 || k===32){
          ev.preventDefault();
          toggle();
        }
      });
    })(tile, grid);

    grid.appendChild(tile);
  }
}

/* Results modal sizing — bigger board with overscan */
var _lbResizeHandler = null;
var LB_OVERSCAN = 1.5; /* make leaderboard larger

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Tycoon — Persona Style (Standalone)</title>

<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">

<!-- PWA + iOS installability -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#c70000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tycoon">
<link rel="apple-touch-icon" href="./assets/icon-180.png">
<link rel="apple-touch-icon" sizes="192x192" href="./assets/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="./assets/icon-512.png">

<style>
  :root{
    --accent: #ff1c1c;
    --accent-dark: #c70000;
    --ink: #000;
    --paper: #fff;
    --ui-gray: #1a1a1a;
    --ui-gray-2: #2c2c2c;
    --shadow: 0 6px 0 var(--ink);
    --warn: #ffcc00;
    --max: 920px;

    --lb-ar: 16/9;

    /* Leaderboard anchor percents */
    --s1-x: 32%; --s1-y: 30%;
    --s2-x: 57%; --s2-y: 44%;
    --s3-x: 34%; --s3-y: 52%;
    --s4-x: 45%; --s4-y: 87%;

    --lb-icon-size: 100px;
  }
  html, body { height: 100%; overflow: hidden; }
  * { box-sizing: border-box; }
  body{
    margin:0;
    font-family: Montserrat, Arial, sans-serif;
    color:#fff;
    min-height:100dvh;
    display:flex;
    align-items: stretch;
    justify-content: center;
    background:
      url('./background/redbg.png') center / cover fixed no-repeat,
      var(--accent-dark);
    outline: 3px solid var(--ink);
    outline-offset: -3px;
  }

  .wrap {
    width: calc(100% - 24px);
    max-width: var(--max);
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Header */
  .title-bar {
    position: relative;
    display:flex; align-items:flex-start; justify-content:flex-end; gap:10px;
    min-height: 72px;
    z-index: 6;
  }
  .logo-img {
    position: absolute;
    left: 6px;
    top: 1px;
    height: 132px;
    width: auto;
    display:block;
    pointer-events: none;
    transform: rotate(-2deg);
    filter: drop-shadow(0 2px 0 var(--ink));
    z-index: 7;
  }

  .controls { display:flex; gap:10px; align-items:center; margin-left: auto; }
  .ctrl-btn {
    font-weight: 900;
    text-transform: uppercase;
    color: var(--paper);
    background: var(--ui-gray-2);
    border: 3px solid var(--ink);
    border-radius: 14px;
    padding: 10px 16px;
    cursor: pointer;
    box-shadow: var(--shadow);
    transform: skewX(-4deg);
    transition: transform 0.08s ease, background 0.2s ease, opacity 0.12s ease;
  }
  .ctrl-btn:hover { background: var(--ink); }
  .ctrl-btn:active { transform: skewX(-4deg) translateY(2px); box-shadow: 0 4px 0 var(--ink); }

  .round-img {
    height: 64px;
    width: auto;
    display:block;
    transform: rotate(-2deg);
    user-select: none;
    pointer-events: none;
    filter: drop-shadow(0 2px 0 var(--ink));
  }

  .table-panel {
    padding: 10px;
    background: #000;
    border: 6px solid #000;
    border-radius: 0;
    box-shadow: var(--shadow);
    position: relative;
    z-index: 5;
  }
  .table-stage {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    border: 6px solid #000;
    border-radius: 0;
    background: #5d5d5d url('./background/starbg.png') center / cover no-repeat;
    color: var(--ink);
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    transition: opacity .2s ease;
  }

  .pile-cards { position: relative; width: 100%; height: 100%; pointer-events:none; }

  .trick-badge {
    position: absolute;
    top: 10px; right: 10px;
    display: none;
    align-items: center; gap: 8px;
    background: var(--warn); color: #000; border: 3px solid var(--ink); border-radius: 999px;
    padding: 6px 10px; font-weight: 900;
    z-index: 60;
  }

  /* Player callout: smaller and slightly lower */
  .player-role-img {
    position: absolute;
    right: 12px;
    bottom: -10px;
    width: 150px;
    height: auto;
    display: none;
    z-index: 101;
    transform: rotate(-2.5deg);
    pointer-events: none;
  }
  @media (max-width: 640px){
    .player-role-img { width: 132px; bottom: -6px; }
  }

  /* In-game overlays (non-interactive) */
  .eight-overlay, .allpass-overlay, .gameset-overlay, .rev-overlay, .revolution-overlay, .cutin-overlay {
    position: absolute; inset: 0;
    display: none;
    align-items: center; justify-content: center;
    pointer-events:none;
  }
  .eight-overlay, .allpass-overlay, .gameset-overlay, .rev-overlay, .revolution-overlay { background: rgba(0,0,0,0.88); z-index: 12000; }
  .cutin-overlay {
    background: #000 center / cover no-repeat;
    z-index: 11950;
    opacity: 0;
    transition: opacity 220ms ease;
  }
  .cutin-overlay.show { display:flex; opacity:1; }
  .cutin-overlay.hide { opacity:0; }

  .eight-overlay img, .allpass-overlay img, .rev-overlay img {
    max-width: 52%;
    max-height: 52%;
    opacity: 0; transform: rotate(-3deg) scale(0.85);
    animation: asset-pop 900ms cubic-bezier(.2,1.1,.2,1) forwards;
  }
  .rev-overlay img { max-width: 64%; max-height: 64%; }
  .gameset-overlay img {
    max-width: 82%;
    max-height: 82%;
    opacity: 0; transform: rotate(-3deg) scale(0.85);
    animation: asset-pop 900ms cubic-bezier(.2,1.1,.2,1) forwards;
  }
  .revolution-overlay img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    opacity: 0; transform: scale(0.92);
    animation: revo-pop 400ms cubic-bezier(.2,1.1,.2,1) forwards;
  }
  @keyframes revo-pop { to { opacity: 1; transform: scale(1.0); } }

  /* Slight screen shake effect while revolution png is visible */
  .revolution-overlay.shake { animation: screen-shake 120ms ease-in-out infinite; }
  @keyframes screen-shake {
    0%   { transform: translate(0, 0); }
    25%  { transform: translate(1.5px, -1px); }
    50%  { transform: translate(-1px, 1.5px); }
    75%  { transform: translate(1px, 1px); }
    100% { transform: translate(0, 0); }
  }

  @keyframes asset-pop {
    0%   { transform: rotate(-8deg) scale(0.75); opacity: 0; }
    45%  { transform: rotate(-2deg) scale(1.08); opacity: 1; }
    100% { transform: rotate(-3deg) scale(1.00); opacity: 1; }
  }

  /* Opponents */
  .opp-panel { padding: 0; background: transparent; border: 0; box-shadow: none; }
  .opp-strip {
    position: relative;
    height: calc(var(--icon-size, 176px));
    margin-top: clamp(32px, calc(40px + var(--icon-size, 176px) * 0.14), 88px);
  }
  .opp-row {
    position: absolute; top: 0;
    display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center;
    transform: translateX(-50%);
  }
  #opp1-row { left: 25%; }
  #opp2-row { left: 50%; }
  #opp3-row { left: 75%; }

  .opp-left { position: relative; width: var(--icon-size, 176px); height: var(--icon-size, 176px); }
  .opp-icon-img { width:100%; height:100%; object-fit:contain; display:block; }
  .opp-count, .opp-name, .opp-role { display:none !important; }

  .beggar-callout-img{
    position: absolute;
    top: calc(-0.30 * var(--icon-size,176px) - 7px);
    left: calc(-0.28 * var(--icon-size,176px) - 5px);
    width: calc(var(--icon-size,176px) * 0.90);
    height: calc(var(--icon-size,176px) * 0.90);
    object-fit: contain;
    display:block;
    z-index: 3;
    transform: rotate(-3deg);
    pointer-events:none;
  }

  /* Hand and controls */
  .handwrap { padding:0; background:transparent !important; border:0 !important; box-shadow:none !important; margin-top:-72px; position: relative; z-index: 100; pointer-events:auto; }
  .handwrap h3 { display:none; }
  .hand { position:relative; height:248px; overflow:visible; padding:2px 4px 6px; z-index: 101; pointer-events:auto; }

  .tcard, .pcard {
    border:2px solid var(--ink);
    border-radius:0;
    box-shadow:var(--shadow);
    color:#222;
    background-color: transparent;
  }
  .tcard {
    width:70px; height:104px; position:absolute;
    user-select:none; cursor:pointer; font-weight:900; --r:0deg; --lift:0px;
    transform: rotate(var(--r)) translateY(var(--lift));
    transition: transform .12s ease, filter .08s ease, opacity .08s ease, box-shadow .1s ease;
    background-image: linear-gradient(135deg,#ffffff,#f0f0f0);
    background-size: 100% 100%;
    pointer-events:auto;
    touch-action: manipulation;
  }
  .tcard .face { text-align:center; line-height:1.1; font-size:14px; }
  .tcard.red { color:#c62828; }
  .tcard.unplayable { filter:brightness(0.62) saturate(0.85); opacity:0.8; }
  .tcard.selected { outline:4px solid var(--accent); --lift:-22px; }
  .tcard.disabled { opacity:0.5; }

  .pcard {
    position:absolute; width:86px; height:120px; display:flex; align-items:center; justify-content:center;
    user-select:none; pointer-events:none; transform-origin:center center; left:50%; top:50%;
    background-image: linear-gradient(135deg,#ffffff,#f0f0f0);
    background-size: 100% 100%;
    will-change: transform, opacity;
  }
  .pcard .face { text-align:center; line-height:1.08; font-weight:900; font-size:18px; }
  .pcard.red { color:#c62828; }
  .pcard.old { filter:brightness(0.58) grayscale(0.25) saturate(0.85); opacity:0.88; }

  .tcard.img-skin, .pcard.img-skin {
    border:2px solid var(--ink) !important;
    box-shadow:var(--shadow);
    background-color:transparent !important;
    background-repeat:no-repeat !important;
    background-size: 100% 100% !important;
    background-position:center !important;
  }

  .hand-controls{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    display:flex; align-items:center; justify-content:center; gap:12px;
    z-index: 10002;
  }
  .hand-controls button{
    background: transparent; border: 0; box-shadow: none; padding: 0;
    width: 148px; height: 58px;
    background-size: contain; background-repeat: no-repeat; background-position: center;
    font-size: 0; cursor: pointer; transition: transform .08s ease, opacity .12s ease;
  }
  #ty-play-btn{ background-image: url('./assets/Play.png'); }
  #ty-pass-btn{ background-image: url('./assets/Pass.png'); }
  .hand-controls button:hover{ transform: translateY(-1px) scale(1.02); }
  .hand-controls button:active{ transform: translateY(1px) scale(0.98); }
  .hand-controls button[disabled]{ opacity:0.55; cursor:not-allowed; transform:none; }

  /* While a modal is open, block clicks to the game; when closed, normal */
  body.modal-open .handwrap,
  body.modal-open .table-panel,
  body.modal-open .controls { pointer-events: none !important; }
  body.modal-open .modal-overlay { pointer-events: auto !important; }

  /* Interactive modals (Setup/Rules/Results) */
  .modal-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.72);
    display:none; align-items:center; justify-content:center;
    z-index: 999999; padding:0; backdrop-filter: blur(2px);
    overflow:hidden; pointer-events:auto;
  }
  #results-modal.modal-overlay { padding: 0 !important; }
  .modal { background: transparent; border:0; border-radius:0; width:100%; max-width:none; box-shadow:none; padding:0; pointer-events:auto; }

  #results-modal .lb-wrap {
    width: 100%;
    max-width: none;
    height: 100%;
    display: grid;
    place-items: center;
    padding-bottom: 88px;
  }

  /* Leaderboard */
  .lb-board {
    position: relative;
    width: 96vw;
    max-width: none;
    aspect-ratio: var(--lb-ar);
    background: url('./assets/Leaderboard.png') center / contain no-repeat;
    margin: 0 auto;
    flex: 0 0 auto;
    will-change: width, transform;
    transform: translateX(var(--lb-shift, 0px));
  }

  .lb-actions {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: max(12px, env(safe-area-inset-bottom));
    width: 100%;
    display:flex;
    gap:12px;
    justify-content:center;
    padding: 0 12px;
    pointer-events: auto;
    z-index: 1000000;
  }

  /* Leaderboard icon slots (refined offsets) */
  .lb-slot {
    position: absolute;
    width: var(--size, var(--lb-icon-size));
    height: var(--size, var(--lb-icon-size));
    left: calc(var(--x) - var(--size, var(--lb-icon-size)) / 2 + var(--dx, 0px));
    top:  calc(var(--y) - var(--size, var(--lb-icon-size)) / 2 + var(--dy, 0px));
    object-fit: contain;
    image-rendering: auto;
    filter: drop-shadow(0 3px 0 var(--ink));
  }
  /* Anchor positions */
  #lb-slot-1 { --x: var(--s1-x); --y: var(--s1-y); --size: var(--lb-icon-size); }
  #lb-slot-2 { --x: var(--s2-x); --y: var(--s2-y); --size: var(--lb-icon-size); }
  #lb-slot-3 { --x: var(--s3-x); --y: var(--s3-y); --size: var(--lb-icon-size); }
  #lb-slot-4 { --x: var(--s4-x); --y: var(--s4-y); --size: var(--lb-icon-size); }

  #lb-slot-1 { --dx: 18px; --dy: -26px; }
  #lb-slot-2 { --dx: -26px; --dy: -4px; }
  #lb-slot-3 { --dx: 24px; --dy: 28px; }
  #lb-slot-4 { --dx: 0px;  --dy: 0px; }

  .lb-score {
    position: absolute;
    font-weight: 900;
    font-size: 22px;
    color: #fff;
    text-shadow:
      -2px -2px 0 var(--ink),
       2px -2px 0 var(--ink),
       2px  2px 0 var(--ink),
       2px  2px 0 var(--ink),
       0px  0px 2px var(--ink);
    white-space: nowrap;
    left: calc(var(--x) + var(--dx, 0px) + var(--size, var(--lb-icon-size))/2 + 14px);
    top:  calc(var(--y) + var(--dy, 0px) - 12px);
    transform: translateY(-50%);
    pointer-events: none;
    user-select: none;
  }
  #lb-score-1 { --x: var(--s1-x); --y: var(--s1-y); --size: var(--lb-icon-size); --dx: 18px; --dy: -26px; }
  #lb-score-2 { --x: var(--s2-x); --y: var(--s2-y); --size: var(--lb-icon-size); --dx: -26px; --dy: -4px; }
  #lb-score-3 { --x: var(--s3-x); --y: var(--s3-y); --size: var(--lb-icon-size); --dx: 24px; --dy: 28px; }
  #lb-score-4 { --x: var(--s4-x); --y: var(--s4-y); --size: var(--lb-icon-size); --dx: 0px;  --dy: 0px; }

  /* Dialogue bubble top-right, icon on the right, bubble to the left */
  .dialogue {
    position: absolute;
    right: 10px;
    top: 6px;
    left: auto;
    bottom: auto;
    display: none;
    align-items: flex-start;
    gap: 8px;
    z-index: 12500;
    pointer-events: none;
    flex-direction: row-reverse; /* icon on the right */
  }
  .dialogue.show { display: flex; animation: dlg-in .18s ease-out; }
  @keyframes dlg-in { from { transform: translateY(-8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .dialogue-icon { width: 56px; height: 56px; object-fit: contain; filter: drop-shadow(0 2px 0 var(--ink)); }
  .dialogue-bubble {
    position: relative; background: var(--paper); color: var(--ink); border: 3px solid var(--ink);
    padding: 6px 10px; border-radius: 12px; font-weight: 900; transform: rotate(-2deg); max-width: 60vw; line-height: 1.15;
  }
  /* Tail on the right, pointing toward the icon */
  .dialogue-bubble::after { content: ""; position: absolute; right: -12px; top: 10px; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-left: 14px solid var(--ink); }
  .dialogue-bubble::before { content: ""; position: absolute; right: -9px; top: 11px; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-left: 12px solid var(--paper); z-index: 1; }
  .dialogue-text { font-size: 16px; }

  /* Revolution status icon (bottom-left) — bigger */
  .revo-ico {
    position: absolute;
    left: 10px;
    bottom: 8px;
    width: clamp(140px, 18vw, 220px);
    height: auto;
    display: none;
    z-index: 12510;
    filter: drop-shadow(0 4px 0 var(--ink));
    pointer-events: none;
    transform: rotate(-1.5deg);
  }

  /* Title overlay */
  .title-overlay {
    position: fixed; inset: 0;
    display: none;
    align-items: center; justify-content: center;
    z-index: 900000;
    background: url('./background/startbg.png') center / cover no-repeat;
    padding: 24px;
  }
  .title-inner {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 16px; transform: rotate(-1.5deg);
  }
  .title-logo {
    width: min(70vw, 580px); max-width: 600px; height: auto;
    filter: drop-shadow(0 6px 0 var(--ink));
    pointer-events: none;
  }
  .title-start, .setup-start {
    width: min(62vw, 460px);
    height: clamp(76px, 12vw, 150px);
    background: url('./assets/start.png') center / contain no-repeat;
    border: 0; padding: 0; cursor: pointer;
    filter: drop-shadow(0 6px 0 var(--ink));
    transition: transform .08s ease, filter .08s ease, opacity .12s ease;
  }
  .title-start:hover, .setup-start:hover { transform: translateY(-1px) rotate(-1.5deg) scale(1.02); }
  .title-start:active, .setup-start:active { transform: translateY(2px) rotate(-1.5deg); filter: drop-shadow(0 4px 0 var(--ink)); }
  .title-start[disabled], .setup-start[disabled] { opacity: .55; cursor: not-allowed; filter: drop-shadow(0 3px 0 var(--ink)); pointer-events: none; }

  /* Setup modal grid */
  #setup-modal.modal-overlay { background: url('./background/startbg.png') center / cover no-repeat; backdrop-filter: none; }
  .choose-img {
    display:block;
    width: min(70vw, 520px);
    max-width: 520px;
    height: auto;
    filter: drop-shadow(0 6px 0 var(--ink));
    transform: rotate(-2.5deg);
    margin: 0 auto 8px;
    user-select: none;
    pointer-events: none;
  }
  .setup-inner {
    width: 100%;
    max-width: 720px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .pt-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; justify-items: center; width: 100%; padding: 8px 12px; }
  @media (max-width: 640px){ .pt-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
  @media (max-width: 420px){ .pt-grid { grid-template-columns: 1fr; } }
  .pt-icon-tile {
    width: 100%;
    max-width: 220px;
    aspect-ratio: 1 / 1;
    background: transparent;
    border: 0; box-shadow: none;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; position:relative; user-select:none;
    transition: transform .1s ease, filter .1s ease;
    outline: none;
  }
  .pt-icon-tile:hover, .pt-icon-tile:focus { transform: translateY(-3px) rotate(-1deg); filter: drop-shadow(0 4px 0 var(--ink)); }
  .pt-icon-tile:active { transform: translateY(1px) rotate(-1deg); filter: drop-shadow(0 2px 0 var(--ink)); }
  .pt-icon-tile img.img { width: 160px; height: 160px; object-fit:contain; display:block; pointer-events:none; }
  .pt-icon-tile.sel img.img { filter:
    drop-shadow(0 -2px 0 var(--accent)) drop-shadow(0 2px 0 var(--accent))
    drop-shadow(-2px 0 0 var(--accent)) drop-shadow(2px 0 0 var(--accent))
    drop-shadow(-1.5px -1.5px 0 var(--accent)) drop-shadow(1.5px -1.5px 0 var(--accent))
    drop-shadow(-1.5px 1.5px 0 var(--accent)) drop-shadow(1.5px 1.5px 0 var(--accent)); }
</style>
</head>

<body>
  <div class="wrap">
    <div class="title-bar">
      <img class="logo-img" id="app-logo" src="./assets/Tycoon.png" alt="Tycoon">
      <div class="controls">
        <button id="ty-start-btn" class="ctrl-btn" title="Open title screen">Start</button>
        <button id="ty-rules-btn" class="ctrl-btn">Rules</button>
        <img id="round-img" class="round-img" alt="Round">
      </div>
    </div>

    <div class="table-panel">
      <div class="table-stage" id="table-stage">
        <div class="pile-cards" id="ty-pile-cards"></div>
        <div class="trick-badge" id="trick-badge">Trick cleared!</div>

        <img id="player-role-img" class="player-role-img" alt="You">

        <!-- Dialogue (top-right): bubble left, icon right -->
        <div id="dialogue" class="dialogue" role="status" aria-live="polite">
          <div class="dialogue-bubble"><span id="dialogue-text" class="dialogue-text"></span></div>
          <img id="dialogue-icon" class="dialogue-icon" alt="">
        </div>

        <!-- Revolution status icon (bottom-left) -->
        <img id="revo-ico" class="revo-ico" src="./assets/revolutionico.png" alt="Revolution Active">

        <!-- In-game overlays -->
        <div class="eight-overlay" id="eight-overlay">
          <img id="img-8stop" src="./assets/8Stop.png" alt="8 STOP" decoding="async" fetchpriority="high">
        </div>
        <div class="allpass-overlay" id="allpass-overlay">
          <img id="img-allpass" src="./assets/AllPass.png" alt="ALL PASS" decoding="async" fetchpriority="high">
        </div>
        <div class="rev-overlay" id="rev-overlay">
          <img id="img-reversal" src="./assets/3spadereverse.png" alt="3♠ REVERSAL" decoding="async">
        </div>
        <div class="revolution-overlay" id="revolution-overlay">
          <img id="img-revolution" src="./assets/revolution.png" alt="REVOLUTION" decoding="async">
        </div>
        <div class="gameset-overlay" id="gameset-overlay">
          <img id="img-gameset" src="./assets/GameSet.png" alt="GAME SET" decoding="async" fetchpriority="high">
        </div>

        <!-- Cut-in overlay -->
        <div class="cutin-overlay" id="cutin-overlay" aria-hidden="true"></div>
      </div>
    </div>

    <div class="opp-panel">
      <div id="opp-strip" class="opp-strip">
        <div id="opp1-row" class="opp-row">
          <div class="opp-left">
            <img id="opp1-icon" class="opp-icon-img" alt="P1">
            <img id="opp1-role-img" class="beggar-callout-img" alt="Role">
            <div id="opp1-count" class="opp-count">14</div>
          </div>
        </div>
        <div id="opp2-row" class="opp-row">
          <div class="opp-left">
            <img id="opp2-icon" class="opp-icon-img" alt="P2">
            <img id="opp2-role-img" class="beggar-callout-img" alt="Role">
            <div id="opp2-count" class="opp-count">14</div>
          </div>
        </div>
        <div id="opp3-row" class="opp-row">
          <div class="opp-left">
            <img id="opp3-icon" class="opp-icon-img" alt="P3">
            <img id="opp3-role-img" class="beggar-callout-img" alt="Role">
            <div id="opp3-count" class="opp-count">14</div>
          </div>
        </div>
      </div>
    </div>

    <div class="handwrap">
      <h3>Hand</h3>
      <div id="ty-hand" class="hand"></div>
      <div class="hand-controls" aria-label="Actions">
        <button id="ty-play-btn" aria-label="Play">Play</button>
        <button id="ty-pass-btn" aria-label="Pass">Pass</button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="results-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="results-title">
    <div class="modal">
      <div class="lb-wrap">
        <div id="lb-board" class="lb-board" aria-label="Leaderboard">
          <img id="lb-slot-1" class="lb-slot" alt="1st">
          <img id="lb-slot-2" class="lb-slot" alt="2nd">
          <img id="lb-slot-3" class="lb-slot" alt="3rd">
          <img id="lb-slot-4" class="lb-slot" alt="4th">
          <div id="lb-score-1" class="lb-score">0 pts</div>
          <div id="lb-score-2" class="lb-score">0 pts</div>
          <div id="lb-score-3" class="lb-score">0 pts</div>
          <div id="lb-score-4" class="lb-score">0 pts</div>
        </div>
        <div class="lb-actions">
          <button id="btn-proceed" class="ctrl-btn">Next Round</button>
          <button id="btn-new-match" class="ctrl-btn" style="display:none;">New Match</button>
          <button id="btn-close-lb" class="ctrl-btn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Setup Modal -->
  <div id="setup-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="setup-title">
    <div class="modal setup-inner">
      <img src="./assets/choose.png" alt="Choose 3 Opponents" class="choose-img" onerror="this.style.display='none'">
      <div id="pt-grid" class="pt-grid" role="listbox" aria-multiselectable="true"></div>
      <div class="actions" style="display:flex;gap:12px;margin:10px 0 0;justify-content:center;">
        <button id="setup-clear" class="ctrl-btn" type="button">Clear</button>
        <button id="setup-start-btn" class="setup-start" disabled aria-label="Begin"></button>
      </div>
    </div>
  </div>

  <!-- Rules Modal -->
  <div id="rules-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="rules-title">
    <div class="modal" style="max-width: 620px;">
      <h3 id="rules-title" style="font-family:'Bangers',system-ui,sans-serif;margin:0 0 8px;color:var(--ink);background:var(--paper);border:3px solid var(--ink);display:inline-block;padding:6px 12px;transform:rotate(-2.5deg);box-shadow:var(--shadow);">Rules (Simplified)</h3>
      <div class="rules-body" style="background:#111;padding:10px;border:3px solid var(--ink);">
        Start with any rank (the holder of 3♦ goes first). On your turn, either:
        - Play the same number of cards (single/pair/triple/quad) of a higher rank than the current set, or
        - Pass.
        When all other players pass, the trick clears and the last player to play starts the next trick.
        First player out wins. Rank order (low→high): 3 4 5 6 7 8 9 10 J Q K A 2 Joker.
        Special rules:
        - 8 Stop — playing any 8 clears the trick immediately and the same player starts a new trick.
        - All Pass — when everyone else passes, a new trick begins (overlay shows just before the new trick).
        - Joker — wild; the highest. A single Joker can be beaten by a single 3♠ immediately after it (“3 of spades reversal”).
        - Revolution — playing four-of-a-kind at once (pairs with Jokers count) reverses rank order until the next Revolution.
      </div>
      <div class="actions" style="display:flex;gap:12px;margin-top:10px;justify-content:center;">
        <button id="rules-close" class="ctrl-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Title screen -->
  <div id="title-screen" class="title-overlay" role="dialog" aria-modal="true" aria-label="Title">
    <div class="title-inner">
      <img class="title-logo" src="./assets/Tycoon.png" alt="Tycoon">
      <button id="title-start-btn" class="title-start" aria-label="Start"></button>
    </div>
  </div>

<script>
/* ES5-only JS — Stable gameflow + reliable Play/select.
   Updates in this build:
   - New playcard SFX: ./sfx/playcard.wav plays whenever cards are played to the pile (player and bots).
   - Select-card SFX retained for player selection taps.
   - Dialogue layout: icon on the right (top-right corner), bubble to the left; protagonist icon equals leaderboard icon.
   - Revolution icon larger and only updates after cut-in + revolution animation (deferred). */

function toArray(nl){ return Array.prototype.slice.call(nl || [], 0); }

/* Icon mapping (+ Player + You alias) */
window.CUSTOM_ICONS = {
  Ryuji:   "./img/Ryuji.png",
  Ann:     "./img/Ann.png",
  Makoto:  "./img/Makoto.png",
  Futaba:  "./img/Futaba.png",
  Yusuke:  "./img/Yusuke.png",
  Haru:    "./img/Haru.png",
  Akechi:  "./img/Akechi.png",
  Sumire:  "./img/Sumire.png",
  Morgana: "./img/Morgana.png",
  Skull:   "./img/Ryuji.png",
  Panther: "./img/Ann.png",
  Queen:   "./img/Makoto.png",
  Oracle:  "./img/Futaba.png",
  Fox:     "./img/Yusuke.png",
  Noir:    "./img/Haru.png",
  Crow:    "./img/Akechi.png",
  Violet:  "./img/Sumire.png",
  Mona:    "./img/Morgana.png",
  Player:  "./img/Player.png",
  You:     "./img/Player.png" /* ensure protagonist dialogue icon matches leaderboard icon */
};

/* Opponent pool */
var PHANTOM_THIEVES = [
  { key:'Skull',   label:'Ryuji'   },
  { key:'Panther', label:'Ann'     },
  { key:'Mona',    label:'Morgana' },
  { key:'Fox',     label:'Yusuke'  },
  { key:'Queen',   label:'Makoto'  },
  { key:'Oracle',  label:'Futaba'  },
  { key:'Noir',    label:'Haru'    },
  { key:'Crow',    label:'Akechi'  },
  { key:'Violet',  label:'Sumire'  }
];

function setIcon(imgEl, name){
  var map = window.CUSTOM_ICONS || {};
  var url = map[name] || '';
  if (imgEl && url){ if (imgEl.src !== url) imgEl.src = url; imgEl.alt = name || ''; }
  else if (imgEl){ imgEl.removeAttribute('src'); imgEl.alt = name || ''; }
}

/* Card imagery */
var CARD_IMG_BASE = './cards';
function mapFileStem(rank){
  var face = { J:'Jack', Q:'Queen', K:'King' };
  if (rank === 'A') return '1';
  if (rank === '10') return '10';
  if (rank === 'JOKER') return 'joker';
  if (face[rank]) return face[rank];
  var n = parseInt(rank, 10);
  if (!isNaN(n) && n >= 2 && n <= 9) return String(n);
  return null;
}
function getCardImageURL(card){
  if (card.rank === 'JOKER') return CARD_IMG_BASE + '/joker.png';
  var stem = mapFileStem(card.rank);
  if (!stem) return null;
  if (card.suit === '♣') return CARD_IMG_BASE + '/' + stem + 'Club.png';
  if (card.suit === '♦') return CARD_IMG_BASE + '/' + stem + 'Diamond.png';
  if (card.suit === '♥') return CARD_IMG_BASE + '/' + stem + 'Heart.png';
  if (card.suit === '♠') return CARD_IMG_BASE + '/' + stem + 'Spade.png';
  return null;
}
function applyCardTexture(el, card){
  var url = getCardImageURL(card);
  if (url){ el.classList.add('img-skin'); el.innerHTML = ''; el.style.backgroundImage = "url('"+url+"')"; }
  else { el.classList.remove('img-skin'); el.style.backgroundImage = ''; }
}

/* Game constants */
var TY_RANKS = ['3','4','5','6','7','8','9','10','J','Q','K','A','2','JOKER'];
var TY_VALUES = (function(){ var o={}, base=3; for (var i=0;i<TY_RANKS.length;i++){ o[TY_RANKS[i]] = base + i; } return o; })();
var TY_SUITS = ['♣','♦','♥','♠'];
var RANK_NAMES = ['Tycoon','Rich','Poor','Beggar'];
var RANK_POINTS = [30,20,10,0];

/* Timing */
var EIGHT_STOP_PRE_DELAY = 600;
var EIGHT_STOP_DELAY     = 1600;

var ALL_PASS_PRE_DELAY   = 900;
var ALL_PASS_DELAY       = 1200;

var GAMESET_PRE_DELAY    = 1400;

var BOT_TURN_DELAY       = 1500;
var PLAYER_PASS_NEXT_DELAY = 700;

/* 3♠ reversal */
var REVERSAL_PRE_DELAY   = 1000;
var REVERSAL_DELAY       = 1800;
var REVERSAL_NEXT_WAIT   = 800;

var REVERSAL_WAIT_AFTER_CUTIN = 350;
var REVERSAL_WAIT_BEFORE_OVERLAY = 600;

/* Revolution sequence */
var REVOLUTION_SHAKE_TIME = 2800;
var REVOLUTION_PRE_DELAY  = 100;

/* Cut-ins */
var CUTIN_APPEAR_DELAY_NEG   = 1400;
var CUTIN_DURATION_NEG       = 2800;
var CUTIN_DURATION_POS       = 2000;

/* Angle rules */
var ANGLE_RANGE = 25;
var ANGLE_DEAD  = 5;

var HAND_CARD_W = 70, HAND_CARD_H = 104, HAND_HEIGHT = 248, HAND_TOP_MARGIN = 8, HAND_BOTTOM_MARGIN = 10;

var match = { totalRounds: 3, roundsPlayed: 0, points: [0,0,0,0] };

/* State */
var ty = {
  deck: [], hands: [[],[],[],[]],
  finished: [false,false,false,false],
  finishOrder: [], lastAction: ['','','',''], lastCards: [[],[],[],[]],
  currentRoles: {},
  botNames: ['Ryuji','Makoto','Yusuke'],
  pile: { rank:null, count:0, by:null, cards: [] },
  pileHistory: [],
  passSet: [false,false,false,false],
  turn: 0,
  selectedIds: {}, selectedRank: null,
  started: false, endingRound: false, _timer: null, _watch: null, _endTimer: null,
  _inEightStop: false,
  _resolvingAllPass: false,
  _inReversal: false,
  _inRevolution: false,
  _inWinCutin: false,
  _anim: { active:false, dir:'bottom', _resetTimer:null },
  /* Stable visuals per trick */
  pileAnglesCurrent: [],
  pileAnglesHistory: [],
  pileOffsetCurrent: {x:0, y:0},
  pileOffsetHistory: [],
  pileFanStepCurrent: 0,
  pileFanStepHistory: [],
  _stepping: false,
  revOrder: false,
  _revoIconDeferred: false
};

/* Setup selection state */
var setupState = { selected: [], listenersBound: false };

/* DOM refs */
var el = {
  rulesBtn: document.getElementById('ty-rules-btn'),
  startBtn: document.getElementById('ty-start-btn'),
  titleScreen: document.getElementById('title-screen'),
  titleStartBtn: document.getElementById('title-start-btn'),

  playBtn: document.getElementById('ty-play-btn'),
  passBtn: document.getElementById('ty-pass-btn'),
  tableStage: document.getElementById('table-stage'),
  pileCards: document.getElementById('ty-pile-cards'),
  trickBadge: document.getElementById('trick-badge'),
  eightOverlay: document.getElementById('eight-overlay'),
  allPassOverlay: document.getElementById('allpass-overlay'),
  revOverlay: document.getElementById('rev-overlay'),
  revolutionOverlay: document.getElementById('revolution-overlay'),
  gamesetOverlay: document.getElementById('gameset-overlay'),
  resultsModal: document.getElementById('results-modal'),
  setupModal: document.getElementById('setup-modal'),
  rulesModal: document.getElementById('rules-modal'),
  playerRoleImg: document.getElementById('player-role-img'),

  oppStrip: document.getElementById('opp-strip'),
  oppRows: [document.getElementById('opp1-row'), document.getElementById('opp2-row'), document.getElementById('opp3-row')],
  opp: [
    { icon: document.getElementById('opp1-icon'), roleImg: document.getElementById('opp1-role-img'), count: document.getElementById('opp1-count') },
    { icon: document.getElementById('opp2-icon'), roleImg: document.getElementById('opp2-role-img'), count: document.getElementById('opp2-count') },
    { icon: document.getElementById('opp3-icon'), roleImg: document.getElementById('opp3-role-img'), count: document.getElementById('opp3-count') }
  ],

  hand: document.getElementById('ty-hand'),
  resultsBoard: document.getElementById('lb-board'),
  lbSlots: [
    document.getElementById('lb-slot-1'),
    document.getElementById('lb-slot-2'),
    document.getElementById('lb-slot-3'),
    document.getElementById('lb-slot-4')
  ],
  lbScores: [
    document.getElementById('lb-score-1'),
    document.getElementById('lb-score-2'),
    document.getElementById('lb-score-3'),
    document.getElementById('lb-score-4')
  ],
  proceedBtn: document.getElementById('btn-proceed'),
  newMatchBtn: document.getElementById('btn-new-match'),
  closeLbBtn: document.getElementById('btn-close-lb'),
  roundImg: document.getElementById('round-img'),

  /* Setup */
  ptGrid: document.getElementById('pt-grid'),
  setupStart: document.getElementById('setup-start-btn'),
  setupClear: document.getElementById('setup-clear'),
  rulesClose: document.getElementById('rules-close'),

  /* Dialogue */
  dlgRoot: document.getElementById('dialogue'),
  dlgIcon: document.getElementById('dialogue-icon'),
  dlgText: document.getElementById('dialogue-text'),

  /* Cut-in */
  cutin: document.getElementById('cutin-overlay'),

  /* Revolution icon */
  revoIco: document.getElementById('revo-ico')
};

/* SFX */
var sfxSelect = (function(){
  try{
    var a = new Audio('./sfx/selectcard.wav');
    a.preload = 'auto';
    a.volume = 0.85;
    return a;
  }catch(e){ return null; }
})();
function playSelectSfx(){
  try{
    if(!sfxSelect) return;
    sfxSelect.currentTime = 0;
    var p = sfxSelect.play();
    if(p && typeof p.catch==='function'){ p.catch(function(){}); }
  }catch(e){}
}
var sfxPlayCard = (function(){
  try{
    var a = new Audio('./sfx/playcard.wav');
    a.preload = 'auto';
    a.volume = 0.9;
    return a;
  }catch(e){ return null; }
})();
function playPlayCardSfx(){
  try{
    if(!sfxPlayCard) return;
    sfxPlayCard.currentTime = 0;
    var p = sfxPlayCard.play();
    if(p && typeof p.catch==='function'){ p.catch(function(){}); }
  }catch(e){}
}

/* Value helpers (support Revolution) */
var LEAD_ORDER_NORM = TY_RANKS.slice(0, 13);
var LEAD_ORDER_REV = LEAD_ORDER_NORM.slice().reverse();
var REV_VALUES = (function(){
  var o={}; var base=3;
  for (var i=0;i<13;i++){ var r=TY_RANKS[i]; o[r] = base + (12 - i); }
  o['JOKER'] = 9999;
  return o;
})();
function valOf(rank){
  if(rank==='JOKER') return 9999;
  return ty.revOrder ? REV_VALUES[rank] : TY_VALUES[rank];
}

/* Helpers */
function buildDeck(){
  var i=0, d=[];
  for(var ri=0; ri<TY_RANKS.length-1; ri++){
    for(var si=0; si<TY_SUITS.length; si++){
      d.push({ id:String(i++), rank:TY_RANKS[ri], suit:TY_SUITS[si], value:TY_VALUES[TY_RANKS[ri]] });
    }
  }
  for (var j=0;j<4;j++){ d.push({ id:String(i++), rank:'JOKER', suit:'🃏', value:TY_VALUES['JOKER'] }); }
  return d;
}
function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j = Math.random()*(i+1)|0; var t=a[i]; a[i]=a[j]; a[j]=t; } }
function nextAlive(from){ var idx=from; for(var step=0; step<4; step++){ idx=(idx+1)%4; if(!ty.finished[idx]) return idx; } return 0; }
function isRoundOver(){
  if(ty.finishOrder.length>=3){
    if(ty.finishOrder.length===3){
      for(var p=0;p<4;p++){ if(ty.finishOrder.indexOf(p)===-1){ ty.finishOrder.push(p); break; } }
    }
    return true;
  }
  return false;
}

function clamp14(n){ n = n|0; if(n<0) return 0; if(n>14) return 14; return n; }
function roleKeyForOpponent(role){ var r=(role||'').toLowerCase(); if(r==='tycoon') return 'tyc'; if(r==='rich') return 'rich'; if(r==='poor') return 'poor'; if(r==='beggar') return 'beggar'; return 'com'; }
function roleKeyForPlayer(role){ var r=(role||'').toLowerCase(); if(r==='tycoon') return 'ptyc'; if(r==='rich') return 'prich'; if(r==='poor') return 'ppoor'; if(r==='beggar') return 'pbeg'; return 'pcom'; }

function isJoker(c){ return c && c.rank==='JOKER'; }
function isThreeOfSpades(c){ return c && c.rank==='3' && c.suit==='♠'; }

/* Cut-in helpers — dynamic file mapping (Player -> joker) */
function nameStemFor(name){
  var map = { 'Sumire':'kasumi', 'You':'joker', 'Player':'joker', 'Joker':'joker' };
  var key = (name||'').trim();
  return map[key] || key.toLowerCase();
}
function getCutinPath(name, mood){ /* mood: 'happy' | 'upset' */
  return './cutins/' + nameStemFor(name) + mood + '.png';
}

/* Dialogue helpers */
function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
var BOT_DIALOG = {
  Ryuji:{pass:["Pass.","Yeah, I got nothing.","Nope."],play1:["Okay, this one.","I'm playing this."],playN:["Here comes a pair.","Three card combo."],eight:["8 Stop! My turn."],jokered:["What—my Joker?!"],revo:["Revolution! Flip the script!"],beggar:["...Seriously? Beggar?!"]},
  Ann:{pass:["I'll pass."],play1:["I'll play this."],playN:["Set time."],eight:["8 Stop!"],jokered:["No way, my Joker!"],revo:["Revolution!"],beggar:["Ugh... Beggar...?"]},
  Makoto:{pass:["Pass—strategically."],play1:["Proceed."],playN:["Set confirmed."],eight:["8 Stop."],jokered:["My Joker... countered."],revo:["Revolution initiated."],beggar:["Unfortunate... Beggar."]},
  Yusuke:{pass:["I shall pass."],play1:["Observe."],playN:["A bold composition."],eight:["8 Stop—cleansed."],jokered:["My Joker has been undone!"],revo:["Behold—Revolution."],beggar:["What a tragic role... Beggar."]},
  Futaba:{pass:["Pass."],play1:["Dropping this."],playN:["Deploying set."],eight:["8 Stop! System purge!"],jokered:["Whoa! My Joker got sniped!"],revo:["Revolution protocol: ON."],beggar:["System error... I'm Beggar?"]},
  Morgana:{pass:["Pass."],play1:["Try this."],playN:["Combo time!"],eight:["8 Stop!"],jokered:["H-hey! My Joker!"],revo:["Revolution time!"],beggar:["Nooo, Beggar? Come on!"]},
  Haru:{pass:["I'll pass."],play1:["Playing this."],playN:["A lovely set."],eight:["8 Stop—fresh start."],jokered:["Oh dear—my Joker."],revo:["Revolution... how exciting."],beggar:["Oh my... Beggar..."]},
  Akechi:{pass:["Pass."],play1:["Simple."],playN:["Check."],eight:["8 Stop."],jokered:["Tch. My Joker."],revo:["Revolution suits me."],beggar:["Beggar? Hmph. Irritating."]},
  Sumire:{pass:["I'll pass."],play1:["Here I go!"],playN:["Stacking up!"],eight:["8 Stop! Reset!"],jokered:["Eep—my Joker!"],revo:["Revolution! Let's do this!"],beggar:["Oh... Beggar... I'll come back!"]}
};
function botLinePlay(name, count){ var d=BOT_DIALOG[name]||{}; var pool=(count===1?d.play1:d.playN)||[]; return pool.length?randPick(pool):(count===1?"Playing this.":"Set—let's go."); }
function botLinePass(name){ var d=BOT_DIALOG[name]||{}; var pool=d.pass||[]; return pool.length?randPick(pool):"I'll pass."; }
function botLineJokered(name){ var d=BOT_DIALOG[name]||{}; var pool=d.jokered||[]; return pool.length?randPick(pool):"My Joker...!"; }
function botLineRevo(name){ var d=BOT_DIALOG[name]||{}; var pool=d.revo||[]; return pool.length?randPick(pool):"Revolution!"; }
function botLineBeggar(name){ var d=BOT_DIALOG[name]||{}; var pool=d.beggar||[]; return pool.length?randPick(pool):"Beggar...?"; }
function showDialogue(name, text, ms){
  if(!el.dlgRoot) return;
  /* Ensure protagonist icon (You) uses leaderboard icon */
  setIcon(el.dlgIcon, name==='You' ? 'Player' : name);
  el.dlgText.textContent = text || '';
  el.dlgRoot.classList.add('show'); clearTimeout(showDialogue._t);
  showDialogue._t = setTimeout(function(){ el.dlgRoot.classList.remove('show'); }, ms || 1500);
}

/* Pass tracking */
function passClear(){ ty.passSet = [false,false,false,false]; }
function passAdd(p){ ty.passSet[p]=true; }
function everyoneElsePassed(){
  if(ty.pile.count===0 || ty.pile.by==null) return false;
  var aliveOthers=0, passed=0;
  for(var p=0;p<4;p++){
    if(ty.finished[p]) continue;
    if(p!==ty.pile.by){ aliveOthers++; if(ty.passSet[p]) passed++; }
  }
  return aliveOthers>0 && passed===aliveOthers;
}

/* Angles utilities */
function randAngle(){ return (Math.random()*2*ANGLE_RANGE) - ANGLE_RANGE; }
function avoidDeadZone(a){
  if (Math.abs(a) < ANGLE_DEAD){
    a = (a < 0 ? -1 : 1) * (ANGLE_DEAD + 1);
    if (a===0) a = (Math.random()<0.5?-1:1) * (ANGLE_DEAD + 1);
  }
  return a;
}
function createAngles(n){
  var res = [];
  for (var i=0;i<n;i++){ res.push(avoidDeadZone(randAngle())); }
  return res;
}
function createAnglesUnique(n, prev){
  var minDelta = 1.2, i;
  if (!prev || prev.length!==n) return createAngles(n);
  var ang = createAngles(n);
  var different=false;
  for(i=0;i<n;i++){ if(Math.abs(ang[i]-prev[i])>=minDelta){ different=true; break; } }
  if(!different){
    var off = (Math.random()<0.5?-1:1)*(1.8+Math.random()*1.6);
    for(i=0;i<n;i++){ ang[i]=avoidDeadZone(ang[i]+off); }
  }
  return ang;
}

/* Center jitter (bigger square) */
function newPileOffset(){
  var x = Math.round((Math.random()*96)-48);
  var y = Math.round((Math.random()*72)-36);
  return {x:x, y:y};
}

/* Fan step (stable per trick) */
function computeFanStep(n){
  if(n===2) return Math.round(24 + Math.random()*18); /* 24..42 */
  if(n===3) return 34;
  if(n===4) return 40;
  return n<=1 ? 0 : Math.min(22, 12 + (n-2)*5);
}

/* UI updaters */
function updateRoundIndicator(){
  var n = Math.min(match.roundsPlayed + 1, match.totalRounds);
  var src = './assets/Round' + n + '.png';
  el.roundImg.src = src; el.roundImg.alt = 'Round ' + n + ' / ' + match.totalRounds;
}
function setOpponentRoleImage(oIndex, role, count){
  var img = el.opp[oIndex].roleImg;
  var src = './ranks/' + roleKeyForOpponent(role) + clamp14(count) + '.png';
  if (img.getAttribute('data-src') !== src){
    img.setAttribute('data-src', src);
    img.src = src;
    img.alt = (role || 'Commoner') + ' ' + clamp14(count);
  }
}
function updatePlayerRoleImage(){
  var node = el.playerRoleImg;
  var role = (ty.currentRoles && ty.currentRoles[0]) || 'Commoner';
  var c = (ty.hands[0] && ty.hands[0].length) ? ty.hands[0].length : 0;
  var src = './ranks/' + roleKeyForPlayer(role) + clamp14(c) + '.png';
  if (node.getAttribute('data-src') !== src){
    node.setAttribute('data-src', src);
    node.src = src;
    node.alt = 'You ' + role + ' ' + clamp14(c);
  }
  node.style.display = 'block';
}
function updateOpponentsUI(){
  var i;
  for(i=0;i<3;i++){
    var name = ty.botNames[i];
    var handCount = ty.hands[i+1] ? ty.hands[i+1].length : 0;
    var roleTxt = ty.currentRoles ? ty.currentRoles[i+1] : 'Commoner';
    setIcon(el.opp[i].icon, name);
    setOpponentRoleImage(i, roleTxt || 'Commoner', handCount);
  }
  updatePlayerRoleImage();
}
function updateRevolutionIcon(){
  if(!el.revoIco) return;
  el.revoIco.style.display = ty.revOrder ? 'block' : 'none';
}

/* Pile drawing — stable angles and fan-step per trick */
function renderPile(){
  var cont = el.pileCards; cont.innerHTML = '';
  var histCount = Math.min(ty.pileHistory.length, ty.pileAnglesHistory.length, ty.pileOffsetHistory.length, ty.pileFanStepHistory.length);
  var startH = Math.max(0, histCount - 5);
  for(var h=startH; h<histCount; h++){
    drawSet(
      ty.pileHistory[h] || [],
      {
        old:true,
        zBase:10+h*10,
        angles: ty.pileAnglesHistory[h] || [],
        offset: ty.pileOffsetHistory[h] || {x:0,y:0},
        fanStep: typeof ty.pileFanStepHistory[h]==='number' ? ty.pileFanStepHistory[h] : computeFanStep((ty.pileHistory[h]||[]).length)
      }
    );
  }
  drawSet(
    ty.pile.cards || [],
    {
      old:false,
      zBase:1000,
      angles: ty.pileAnglesCurrent || [],
      offset: ty.pileOffsetCurrent || {x:0,y:0},
      fanStep: ty.pileFanStepCurrent || computeFanStep((ty.pile.cards||[]).length)
    }
  );
}

function drawSet(cards, opts){
  var old = !!opts.old, zBase = opts.zBase|0;
  var n=cards.length; if(!n) return;

  /* Jokers underneath when mixed */
  var viewCards = cards.slice(0);
  var hasJ=false, hasNon=false;
  for(var ii=0; ii<viewCards.length; ii++){ if(isJoker(viewCards[ii])) hasJ=true; else hasNon=true; }
  if(hasJ && hasNon){
    viewCards.sort(function(a,b){
      if(isJoker(a) && !isJoker(b)) return -1;
      if(!isJoker(a) && isJoker(b)) return 1;
      return 0;
    });
  }

  /* Fan — from opts (stable), else default */
  var fanStep = (opts && typeof opts.fanStep==='number') ? opts.fanStep : computeFanStep(n);

  /* Angles: use provided ones when available to keep stable; otherwise random/manual */
  var manualAngles = null;
  if(n===3) manualAngles=[-20,0,20];
  else if(n===4) manualAngles=[-22,-10,10,22];

  var angles = opts.angles || [];
  var mid = (n-1)/2;
  var off = opts.offset || {x:0,y:0};

  for(var i=0;i<n;i++){
    var c=viewCards[i]; var d=document.createElement('div');
    d.className='pcard'+((c.suit==='♦'||c.suit==='♥')?' red':'')+(old?' old':'');
    d.innerHTML='<div class="face">'+c.rank+'<br>'+c.suit+'</div>';
    applyCardTexture(d,c);

    var ang;
    if(typeof angles[i] === 'number'){
      ang = angles[i];
    } else if (manualAngles) {
      ang = manualAngles[i];
    } else {
      ang = avoidDeadZone(randAngle());
    }

    var dx = (i - mid) * fanStep + off.x;
    var dy = off.y;
    d.style.zIndex=String(zBase+i);

    if(!old && ty._anim && ty._anim.active){
      var dir = ty._anim.dir || 'bottom';
      var xoff = 0, yoff = 0;
      if (dir==='left')       { xoff = -600; yoff = 0; }
      else if (dir==='right') { xoff = 600;  yoff = 0; }
      else if (dir==='top')   { xoff = 0;    yoff = -420; }
      else                    { xoff = 0;    yoff = 420; }

      d.style.transition = 'transform 320ms cubic-bezier(.2,.9,.2,1), opacity 220ms ease-out';
      d.style.opacity = '0.01';
      d.style.transform='translate(-50%,-50%) translate('+xoff+'px,'+yoff+'px) translate('+dx+'px,'+dy+'px) rotate('+ang+'deg)';
      el.pileCards.appendChild(d);

      d.getBoundingClientRect();
      (function(node, a, dxpx, dypx){
        requestAnimationFrame(function(){
          node.style.opacity='1';
          node.style.transform='translate(-50%,-50%) translate('+dxpx+'px,'+dypx+'px) rotate('+a+'deg)';
        });
      })(d, ang, dx, dy);
    } else {
      d.style.transform='translate(-50%,-50%) translate('+dx+'px,'+dy+'px) rotate('+ang+'deg)';
      el.pileCards.appendChild(d);
    }
  }
}

/* Layout hand */
function layoutFanHandFlat(){
  var cards = toArray(el.hand.querySelectorAll('.tcard')); var n=cards.length; if(!n) return;
  var boxW = el.hand.clientWidth; var boxH = el.hand.clientHeight;
  var padX=8, cardW=HAND_CARD_W, cardH=HAND_CARD_H;
  var innerW = Math.max(80, boxW - padX*2);
  var spacing = n>1 ? (innerW - cardW) / (n-1) : 0; spacing = Math.max(16, Math.min(46, spacing));
  var usedW = cardW + spacing*(n-1); var startLeft = Math.round((boxW - usedW)/2);
  var maxAngle = Math.max(4, Math.min(10, 18 - Math.floor(n/2)));
  var maxLift  = Math.max(12, Math.min(24, 40 - Math.floor(n)));
  var minBase = HAND_TOP_MARGIN + maxLift; var maxBase = boxH - cardH - HAND_BOTTOM_MARGIN;
  var baseTop = Math.round(boxH * 0.48);
  baseTop = Math.max(minBase, Math.min(maxBase, baseTop));
  var mid=(n-1)/2;
  for(var i=0;i<n;i++){
    var t=(i-mid)/(mid||1); var angle=t*maxAngle; var lift=Math.round((1-Math.abs(t))*maxLift);
    var left=Math.round(startLeft+i*spacing); var top=Math.round(baseTop-lift);
    var card=cards[i];
    if(card.dataset._l!=left){ card.style.left=(card.dataset._l=left)+'px'; }
    if(card.dataset._t!=top){ card.style.top=(card.dataset._t=top)+'px'; }
    card.style.zIndex=String(100+i); card.style.setProperty('--r', angle.toFixed(2)+'deg');
  }
}

/* Buttons + highlight */
function ty_updateButtons(){
  var yourTurn = ty.turn===0 && !ty.finished[0] && ty.started && !isRoundOver();
  var playable = yourTurn && ty_canPlaySelection();
  el.passBtn.disabled = !(yourTurn && ty.pile.count>0);
  el.playBtn.disabled = !playable;
}
function ty_highlightPlayable(){
  var yourTurn = ty.turn===0 && !ty.finished[0] && ty.started && !isRoundOver();
  var cards = toArray(document.querySelectorAll('#ty-hand .tcard'));
  var i;
  for(i=0;i<cards.length;i++){ cards[i].classList.remove('unplayable','disabled'); }
  if(!yourTurn) { for(i=0;i<cards.length;i++) cards[i].classList.add('disabled'); return; }
  if(ty.pile.count===0) return;

  var need = ty.pile.count, minVal = valOf(ty.pile.rank);
  var hand = ty.hands[0];

  if (ty.pile.rank==='JOKER'){
    for (i=0;i<cards.length;i++){
      var r = cards[i].dataset.rank, s = cards[i].dataset.suit;
      var allow = (need===1 && r==='3' && s==='♠');
      if (!allow) cards[i].classList.add('unplayable');
    }
    return;
  }

  var counts = (function(cards){ var m={}; for(var k=0;k<cards.length;k++){ m[cards[k].rank]=(m[cards[k].rank]||0)+1; } return m; })(hand);
  var jokers = (function(h){ var a=[]; for(var k=0;k<h.length;k++){ if(isJoker(h[k])) a.push(h[k]); } return a; })(hand);
  var jokerCount = jokers.length;
  var allowedIds = {};

  if(jokerCount >= need){
    for (var ji=0; ji<jokers.length; ji++) allowedIds[jokers[ji].id]=true;
  }

  for (var ri=0; ri<13; ri++){
    var rk = TY_RANKS[ri];
    if (valOf(rk) <= minVal) continue;
    var have = counts[rk]||0;
    if (have + jokerCount >= need){
      for (i=0;i<hand.length;i++){
        var c = hand[i];
        if (c.rank===rk || isJoker(c)) allowedIds[c.id]=true;
      }
    }
  }

  for(i=0;i<cards.length;i++){
    var id = cards[i].dataset.id;
    if(!allowedIds[id]) cards[i].classList.add('unplayable');
  }
}

/* Selection helpers */
function selHas(id){ return !!ty.selectedIds[id]; }
function selAdd(id){ ty.selectedIds[id]=true; }
function selDel(id){ delete ty.selectedIds[id]; }
function selClear(){ ty.selectedIds={}; }
function selCount(){ var n=0; for(var k in ty.selectedIds){ if(ty.selectedIds.hasOwnProperty(k)) n++; } return n; }
function selectionCards(){ return ty.hands[0].filter(function(c){ return selHas(c.id); }); }

/* Render-all with optional animation */
function ty_renderAll(opts){
  if(opts && opts.animateDir){
    ty._anim.active = true;
    ty._anim.dir = opts.animateDir;
    if (ty._anim._resetTimer){ clearTimeout(ty._anim._resetTimer); }
    ty._anim._resetTimer = setTimeout(function(){ ty._anim.active = false; }, 420);
  }
  renderPile();
  updateOpponentsUI();
  el.hand.innerHTML=''; el.hand.style.height = HAND_HEIGHT + 'px';
  var yourTurn = ty.turn===0 && !ty.finished[0] && ty.started && !isRoundOver();
  for(var i=0;i<ty.hands[0].length;i++){
    var card=ty.hands[0][i];
    var d=document.createElement('div');
    d.className='tcard'+((card.suit==='♦'||card.suit==='♥')?' red':'');
    d.dataset.id=card.id; d.dataset.rank=card.rank; d.dataset.suit=card.suit;
    d.innerHTML='<div class="face">'+card.rank+'<br>'+card.suit+'</div>';
    applyCardTexture(d, card);
    if(selHas(card.id)) d.classList.add('selected');
    if(!yourTurn) d.classList.add('disabled');
    (function(cobj, node){
      function onSel(ev){
        if(ev){ ev.preventDefault(); ev.stopPropagation(); }
        ty_toggleSelect(cobj);
      }
      node.addEventListener('click', onSel, false);
    })(card, d);
    el.hand.appendChild(d);
  }
  requestAnimationFrame(function(){ layoutFanHandFlat(); ty_highlightPlayable(); ty_updateButtons(); });
}

/* Ensure UI refresh when player gains turn */
function ty_enterPlayerTurn(){
  ty_updateButtons();
  if(ty.turn===0 && !ty.finished[0] && ty.started && !isRoundOver()){
    ty_renderAll();
    ty_updateButtons();
  }
}

/* Utilities */
function dirForIndex(idx){
  return (idx===1)?'left':(idx===2?'top':(idx===3?'right':'bottom'));
}

/* Validate an arbitrary set of cards against current pile (for bots) */
function effRankOf(cards){
  for(var i=0;i<cards.length;i++){ if(!isJoker(cards[i])) return cards[i].rank; }
  return 'JOKER';
}
function canPlayCardsAgainstPile(cards){
  if(!cards || !cards.length) return false;
  var count = cards.length;
  var effRank = effRankOf(cards);

  if(ty.pile.count===0) return true;

  if(count !== ty.pile.count) return false;

  if (ty.pile.rank==='JOKER'){
    return (ty.pile.count===1 && count===1 && isThreeOfSpades(cards[0]));
  }

  return valOf(effRank) > valOf(ty.pile.rank);
}

/* 3♠ SEQUENCE — pre happy cut-in, then card drop, then overlay */
function triggerThreeSpadeSequence(by, card3s){
  if(!card3s || !isThreeOfSpades(card3s)) return;
  ty._inReversal = true;

  var actorName = (by===0) ? 'You' : ty.botNames[by-1];
  var preUrl = getCutinPath(actorName, 'happy');

  showCutIn(preUrl, CUTIN_DURATION_POS, function(){
    setTimeout(function(){
      var idset = {}; idset[card3s.id]=true;
      var remain=[]; for(var i=0;i<ty.hands[by].length;i++){ var c=ty.hands[by][i]; if(!idset[c.id]) remain.push(c); }
      ty.hands[by]=remain;

      ty_setPile(by, '3', [card3s], dirForIndex(by));
      showDialogue(actorName, "3♠ reversal!", 1600);

      if(ty.hands[by].length===0 && ty.finishOrder.indexOf(by)===-1){
        ty.finished[by]=true;
        ty.finishOrder.push(by);
      }

      setTimeout(function(){
        el.revOverlay.style.display='flex';
        setTimeout(function(){
          el.revOverlay.style.display='none';

          ty.pile={rank:null,count:0,by:null,cards:[]};
          ty.pileHistory=[];
          ty.pileAnglesCurrent=[];
          ty.pileAnglesHistory=[];
          ty.pileOffsetCurrent={x:0,y:0};
          ty.pileOffsetHistory=[];
          ty.pileFanStepCurrent=0;
          ty.pileFanStepHistory=[];
          passClear();

          var starter = (!ty.finished[by]) ? by : nextAlive(by);
          ty.turn = starter;

          ty_renderAll();
          ty_updateButtons();

          ty._inReversal = false;

          if(isRoundOver()){
            scheduleFinishRound();
          } else {
            if(ty.turn!==0) ty_queueNextStep(REVERSAL_NEXT_WAIT);
            else ty_enterPlayerTurn();
          }
        }, REVERSAL_DELAY);
      }, REVERSAL_WAIT_BEFORE_OVERLAY);

    }, REVERSAL_WAIT_AFTER_CUTIN);
  });
}

/* Revolution sequence — happy cut-in -> revolution.png shake -> resume; icon display is deferred */
function triggerRevolutionSequence(by, onDone){
  ty._inRevolution = true;
  var actorName = (by===0) ? 'You' : ty.botNames[by-1];
  var happyUrl = getCutinPath(actorName, 'happy');

  showCutIn(happyUrl, CUTIN_DURATION_POS, function(){
    setTimeout(function(){
      try{
        var ov = el.revolutionOverlay;
        if(ov){
          ov.classList.remove('shake');
          ov.style.display='flex';
          void ov.offsetHeight;
          ov.classList.add('shake');
          setTimeout(function(){
            ov.classList.remove('shake');
            ov.style.display='none';

            if(ty._revoIconDeferred){
              updateRevolutionIcon();
              ty._revoIconDeferred = false;
            }

            ty._inRevolution = false;
            if(typeof onDone==='function') onDone();
          }, Math.max(1400, REVOLUTION_SHAKE_TIME|0));
        } else {
          if(ty._revoIconDeferred){
            updateRevolutionIcon();
            ty._revoIconDeferred = false;
          }
          ty._inRevolution = false;
          if(typeof onDone==='function') onDone();
        }
      }catch(e){
        if(ty._revoIconDeferred){
          updateRevolutionIcon();
          ty._revoIconDeferred = false;
        }
        ty._inRevolution = false;
        if(typeof onDone==='function') onDone();
      }
    }, Math.max(0, REVOLUTION_PRE_DELAY|0));
  });
}

/* Selection behavior (hand) */
function ty_toggleSelect(card){
  playSelectSfx(); /* SFX on player selection */
  var yourTurn = ty.turn===0 && !ty.finished[0] && ty.started && !isRoundOver();
  var hand = ty.hands[0];
  var need = ty.pile.count;

  if(!yourTurn){
    if(selHas(card.id)){ selDel(card.id); } else { if(selCount()>=4) selClear(); selAdd(card.id); }
    ty_renderAll();
    return;
  }

  if (ty.pile.count>0 && ty.pile.rank==='JOKER'){
    selClear();
    if (need===1 && isThreeOfSpades(card)){
      selAdd(card.id);
      ty.selectedRank = '3';
    } else {
      ty.selectedRank = null;
    }
    ty_renderAll();
    return;
  }

  if(ty.pile.count===0){
    if(selHas(card.id)){ selDel(card.id); } else { selAdd(card.id); }
    if(selCount()>4){ selClear(); selAdd(card.id); }
    ty.selectedRank = (selCount()? (function(sel){ for(var i=0;i<sel.length;i++){ if(!isJoker(sel[i])) return sel[i].rank; } return 'JOKER'; })(hand.filter(function(c){return selHas(c.id);})): null);
    ty_renderAll();
    return;
  }

  /* Responding: auto-pick exact count with jokers if needed */
  selClear();
  var targetRank = isJoker(card) ? null : card.rank;
  var jokers = (function(h){ var a=[]; for(var i=0;i<h.length;i++){ if(isJoker(h[i])) a.push(h[i]); } return a; })(hand);
  var jokerIds = toArray(jokers).map(function(c){return c.id;});
  var picked=0;

  if(targetRank){
    var same = (function(h, r){ var a=[]; for(var i=0;i<h.length;i++){ if(h[i].rank===r) a.push(h[i]); } return a; })(hand, targetRank);
    for(var i=0;i<same.length && picked<need;i++){ selAdd(same[i].id); picked++; }
    for(var j=0;j<jokerIds.length && picked<need;j++){ selAdd(jokerIds[j]); picked++; }
    ty.selectedRank = targetRank;
  } else {
    for(var j2=0;j2<jokerIds.length && picked<need;j2++){ selAdd(jokerIds[j2]); picked++; }
    ty.selectedRank = 'JOKER';
  }

  ty_renderAll();
}

/* Rules checker (player) */
function ty_canPlaySelection(){
  var sel = selectionCards();
  if(!sel.length) return false;

  var count = sel.length;
  if (count < 1 || count > 4) return false;

  var nonJRank = null;
  for (var i=0;i<sel.length;i++){
    if (!isJoker(sel[i])){
      if (nonJRank === null) nonJRank = sel[i].rank;
      else if (sel[i].rank !== nonJRank) return false;
    }
  }
  var effRank = nonJRank || 'JOKER';

  if(ty.pile.count===0) return true;

  if(count !== ty.pile.count) return false;

  if (ty.pile.rank==='JOKER'){
    var only = selectionCards();
    return (ty.pile.count===1 && count===1 && only.length===1 && isThreeOfSpades(only[0]));
  }

  return valOf(effRank) > valOf(ty.pile.rank);
}

/* Revolution detection (flip order + return boolean). Icon display is deferred. */
function maybeTriggerRevolution(by, cards, effRank){
  if(cards.length!==4) return false;
  var nonJ = []; for(var i=0;i<cards.length;i++){ if(!isJoker(cards[i])) nonJ.push(cards[i].rank); }
  if(nonJ.length===0) return false;
  var distinct = {}; for(var j=0;j<nonJ.length;j++){ distinct[j] = true; distinct[nonJ[j]] = true; } /* keep */
  var keys = []; for (var k in distinct){ if(distinct.hasOwnProperty(k)) keys.push(k); }
  if(keys.length>1) return false;

  ty.revOrder = !ty.revOrder;
  ty._revoIconDeferred = true; /* only show/hide icon after seq completes */

  var speakerIndex = (by===0) ? nextAlive(0) : by;
  if(speakerIndex>=1 && speakerIndex<=3){
    var name = ty.botNames[speakerIndex-1];
    showDialogue(name, botLineRevo(name), 1800);
  }
  return true;
}

/* Central pile setter */
function ty_setPile(by, effRank, cards, animateDir){
  if(ty.pile.cards && ty.pile.cards.length){
    ty.pileHistory.push(ty.pile.cards.slice(0));
    ty.pileAnglesHistory.push((ty.pileAnglesCurrent || []).slice(0));
    ty.pileOffsetHistory.push({x: ty.pileOffsetCurrent.x, y: ty.pileOffsetCurrent.y});
    ty.pileFanStepHistory.push(ty.pileFanStepCurrent);
    if(ty.pileHistory.length>5){
      ty.pileHistory = ty.pileHistory.slice(-5);
      ty.pileAnglesHistory = ty.pileAnglesHistory.slice(-5);
      ty.pileOffsetHistory = ty.pileOffsetHistory.slice(-5);
      ty.pileFanStepHistory = ty.pileFanStepHistory.slice(-5);
    }
  }
  ty.pile = { rank: effRank, count: cards.length, by: by, cards: cards.slice(0) };
  ty.pileAnglesCurrent = createAnglesUnique(cards.length, ty.pileAnglesCurrent);
  ty.pileOffsetCurrent = newPileOffset();
  ty.pileFanStepCurrent = computeFanStep(cards.length);
  passClear();

  /* Play SFX when cards are played down */
  playPlayCardSfx();

  ty_renderAll({ animateDir: animateDir });
  ty_updateButtons();
}

/* Player play */
function ty_playSelected(){
  if(!ty_canPlaySelection()) return;
  var sel = selectionCards();

  var respondingToJoker = (ty.pile.count===1 && ty.pile.rank==='JOKER');
  var wasJokerResponse = (respondingToJoker && sel.length===1 && isThreeOfSpades(sel[0]));

  if (wasJokerResponse && !isRoundOver()){
    selClear(); ty.selectedRank=null; ty_updateButtons();
    triggerThreeSpadeSequence(0, sel[0]);
    return;
  }

  /* Pre-win happy cut-in: if you'd go out FIRST with this play */
  var goingOutFirst = (ty.finishOrder.length===0 && ty.hands[0].length === sel.length);
  if(goingOutFirst && !ty._inWinCutin){
    ty._inWinCutin = true;
    showCutIn(getCutinPath('You','happy'), CUTIN_DURATION_POS, function(){
      ty._inWinCutin = false;
      /* Re-validate before committing */
      if(!ty_canPlaySelection()){
        ty_updateButtons();
        return;
      }
      _commitPlayerPlay(sel);
    });
    return;
  }

  _commitPlayerPlay(sel);
}

function _commitPlayerPlay(sel){
  var ids={}; for(var i=0;i<sel.length;i++){ ids[sel[i].id]=true; }
  ty.hands[0] = ty.hands[0].filter(function(c){ return !ids[c.id]; });

  var effRank = (function(){ for(var i=0;i<sel.length;i++){ if(!isJoker(sel[i])) return sel[i].rank; } return 'JOKER'; })();

  ty_setPile(0, effRank, sel, 'bottom');

  var didRevo = maybeTriggerRevolution(0, sel, effRank);

  selClear(); ty.selectedRank=null;

  if(ty.hands[0].length===0 && !ty.finished[0]){ ty.finished[0]=true; ty.finishOrder.push(0); }

  function continueAfterAnySpecials(){
    if(effRank==='8' && !isRoundOver()){
      eightStop(0);
      return;
    }
    if(isRoundOver()){ scheduleFinishRound(); return; }

    ty.turn = nextAlive(0);
    ty_updateButtons();
    ty_queueNextStep(BOT_TURN_DELAY);
  }

  if(didRevo){
    triggerRevolutionSequence(0, continueAfterAnySpecials);
    return;
  }

  continueAfterAnySpecials();
}

function ty_pass(){
  if(ty.turn!==0 || ty.pile.count===0) return;
  passAdd(0);

  if(resolveAllPassIfNeeded()){ ty_updateButtons(); return; }

  ty.turn=nextAlive(0);
  ty_updateButtons();
  if(isRoundOver()){ scheduleFinishRound(); return; }
  ty_queueNextStep(BOT_TURN_DELAY + PLAYER_PASS_NEXT_DELAY);
}

/* All Pass */
function resolveAllPassIfNeeded(){
  if(ty._resolvingAllPass) return true;
  if(!everyoneElsePassed()) return false;

  ty._resolvingAllPass = true;
  var starter = ty.pile.by;

  setTimeout(function(){
    el.allPassOverlay.style.display='flex';

    setTimeout(function(){
      el.allPassOverlay.style.display='none';
      ty.pile={rank:null,count:0,by:null,cards:[]};
      ty.pileHistory=[];
      ty.pileAnglesCurrent=[];
      ty.pileAnglesHistory=[];
      ty.pileOffsetCurrent={x:0,y:0};
      ty.pileOffsetHistory=[];
      ty.pileFanStepCurrent=0;
      ty.pileFanStepHistory=[];
      passClear();
      ty.turn = (!ty.finished[starter]) ? starter : nextAlive(starter);
      ty._resolvingAllPass = false;
      ty_renderAll();
      ty_updateButtons();
      if(!isRoundOver()){
        if(ty.turn!==0) ty_queueNextStep(BOT_TURN_DELAY);
        else ty_enterPlayerTurn();
      } else {
        scheduleFinishRound();
      }
    }, ALL_PASS_DELAY);

  }, ALL_PASS_PRE_DELAY);

  return true;
}

/* Manual clear */
function ty_clearTrick(flash){
  if(flash===undefined) flash=false;
  if(ty.pile.count===0) return false;
  var starter=ty.pile.by;
  ty.pile={rank:null,count:0,by:null,cards:[]};
  ty.pileHistory=[];
  ty.pileAnglesCurrent=[];
  ty.pileAnglesHistory=[];
  ty.pileOffsetCurrent={x:0,y:0};
  ty.pileOffsetHistory=[];
  ty.pileFanStepCurrent=0;
  ty.pileFanStepHistory=[];
  passClear();
  ty.turn = (!ty.finished[starter]) ? starter : nextAlive(starter);
  if(flash){
    el.trickBadge.style.display='inline-flex';
    setTimeout(function(){ el.trickBadge.style.display='none'; }, 900);
  }
  ty_renderAll();
  ty_updateButtons();
  return true;
}

/* 8 Stop */
function eightStop(by){
  if (ty._inEightStop) return;
  ty._inEightStop = true;

  setTimeout(function(){
    el.eightOverlay.style.display='flex';
    el.pileCards.style.visibility='hidden';
    setTimeout(function(){
      el.eightOverlay.style.display='none';
      el.pileCards.style.visibility='visible';
      ty.pile={rank:null,count:0,by:null,cards:[]};
      ty.pileHistory=[];
      ty.pileAnglesCurrent=[];
      ty.pileAnglesHistory=[];
      ty.pileOffsetCurrent={x:0,y:0};
      ty.pileOffsetHistory=[];
      ty.pileFanStepCurrent=0;
      ty.pileFanStepHistory=[];
      passClear();
      ty.turn = (!ty.finished[by]) ? by : nextAlive(by);
      ty._inEightStop = false;
      ty_renderAll();
      ty_updateButtons();
      if(!isRoundOver()){
        if(ty.turn!==0) ty_queueNextStep(450);
        else ty_enterPlayerTurn();
      } else {
        scheduleFinishRound();
      }
    }, EIGHT_STOP_DELAY);
  }, EIGHT_STOP_PRE_DELAY);
}

/* Turn queue + watchdog */
function ty_queueNextStep(delay){
  if(delay===undefined) delay=BOT_TURN_DELAY;
  if(ty._timer){ clearTimeout(ty._timer); ty._timer=null; }
  if(ty._watch){ clearTimeout(ty._watch); ty._watch=null; }
  if(!ty.started || isRoundOver() || ty.endingRound) return;
  if(ty._resolvingAllPass || ty._inEightStop || ty._inReversal || ty._inRevolution || ty._inWinCutin) return;
  if(ty.turn!==0 && !ty.finished[ty.turn]){
    ty._timer = setTimeout(function(){
      try { ty_stepTurn(); } catch(e){ ty_queueNextStep(300); }
    }, delay);
    ty._watch = setTimeout(function(){
      if(!ty.started || isRoundOver() || ty.endingRound) return;
      if(ty._resolvingAllPass || ty._inEightStop || ty._inReversal || ty._inRevolution || ty._inWinCutin) return;
      if(ty.turn!==0 && !ty.finished[ty.turn]){ ty_queueNextStep(200); }
    }, delay + 1000);
  }
}

/* Bot step */
function ty_stepTurn(){
  if(ty._stepping) return; ty._stepping = true;
  try{
    if(ty._watch){ clearTimeout(ty._watch); ty._watch=null; }
    if(ty._resolvingAllPass || ty._inEightStop || ty._inReversal || ty._inRevolution || ty._inWinCutin) return;

    if(isRoundOver() || !ty.started){ if(isRoundOver()) scheduleFinishRound(); return; }

    var b=ty.turn;
    ty_updateButtons();
    if(b===0 || ty.finished[b]){ ty_enterPlayerTurn(); return; }

    if(ty.hands[b].length===0){
      ty.finished[b]=true; if(ty.finishOrder.indexOf(b)===-1) ty.finishOrder.push(b);
      ty.turn=nextAlive(b);
      ty_renderAll();
      ty_updateButtons();
      if(!isRoundOver() && ty.turn!==0) ty_queueNextStep(Math.max(350,BOT_TURN_DELAY/2)); else if(isRoundOver()) scheduleFinishRound();
      return;
    }

    var botName = (b>=1 && b<=3) ? ty.botNames[b-1] : 'You';
    var played=false, playedRank=null;

    var need = ty.pile.count;
    var counts = (function(cards){ var m={}; for(var i=0;i<cards.length;i++){ m[cards[i].rank]=(m[cards[i].rank]||0)+1; } return m; })(ty.hands[b]);

    function proceedToNextTurn(){
      if(isRoundOver()){ scheduleFinishRound(); return; }
      ty.turn=nextAlive(b);
      ty_updateButtons();
      if(!isRoundOver() && ty.turn!==0) ty_queueNextStep(BOT_TURN_DELAY); else if(isRoundOver()) scheduleFinishRound();
    }

    function handleSpecialsThenProceed(set, rank){
      var didRevo = (set && set.length===4) ? maybeTriggerRevolution(b, set, rank) : false;

      if(ty.hands[b].length===0 && ty.finishOrder.indexOf(b)===-1){ ty.finished[b]=true; ty.finishOrder.push(b); }

      if(didRevo){
        triggerRevolutionSequence(b, function(){
          if(rank==='8' && !isRoundOver()){ eightStop(b); return; }
          proceedToNextTurn();
        });
        return;
      }

      if(rank==='8' && !isRoundOver()){ eightStop(b); return; }

      proceedToNextTurn();
    }

    function maybePreCutinThenPlay(set, rank){
      var goingOutFirst = (ty.finishOrder.length===0 && ty.hands[b].length===set.length);
      if(goingOutFirst){
        var url = getCutinPath(botName, 'happy');
        showCutIn(url, CUTIN_DURATION_POS, function(){
          if(ty.pile.count>0 && !canPlayCardsAgainstPile(set)){ passAdd(b); proceedToNextTurn(); return; }
          ty_botPlayExact(b, set, rank);
          showDialogue(botName, botLinePlay(botName, set.length), 1400);
          handleSpecialsThenProceed(set, rank);
        });
        return true;
      }
      return false;
    }

    if(ty.pile.count===0){
      var leadCards = null; var leadRank=null;

      var ORDER = ty.revOrder ? LEAD_ORDER_REV : LEAD_ORDER_NORM;

      for (var oi=0; oi<ORDER.length && !leadCards; oi++){
        var rk = ORDER[oi];
        var c = counts[rk]||0;
        if (c>=2){
          var take = (c>=3 && Math.random()<0.35) ? 3 : 2;
          leadCards = [];
          for (var i=0;i<ty.hands[b].length && leadCards.length<take;i++){ if(ty.hands[b][i].rank===rk){ leadCards.push(ty.hands[b][i]); } }
          leadRank = rk;
        }
      }

      if(!leadCards){
        for (var oi2=0; oi2<ORDER.length && !leadCards; oi2++){
          var rk2 = ORDER[oi2];
          for (var i2=0;i2<ty.hands[b].length;i2++){ var c2=ty.hands[b][i2]; if(c2.rank===rk2){ leadCards=[c2]; leadRank=rk2; break; } }
        }
      }

      if(!leadCards){
        for (var j=0;j<ty.hands[b].length;j++){ if(isJoker(ty.hands[b][j])){ leadCards=[ty.hands[b][j]]; leadRank='JOKER'; break; } }
      }

      if(leadCards){
        if(maybePreCutinThenPlay(leadCards, leadRank)){ return; }
        ty_botPlayExact(b, leadCards, leadRank);
        played=true; playedRank=leadRank;
        showDialogue(botName, botLinePlay(botName, leadCards.length), 1600);
      }
    } else {
      var minVal=valOf(ty.pile.rank);

      var candidate=null;
      for (var ri3=0; ri3<13; ri3++){
        var r=TY_RANKS[ri3];
        if ((counts[r]||0)>=need && valOf(r)>minVal){ candidate=r; break; }
      }
      if(candidate){
        var set=[], kk=0;
        for (var i3=0;i3<ty.hands[b].length && kk<need;i3++){ var cc=ty.hands[b][i3]; if(cc.rank===candidate){ set.push(cc); kk++; } }
        if(maybePreCutinThenPlay(set, candidate)){ return; }
        if(canPlayCardsAgainstPile(set)){
          ty_botPlayExact(b, set, candidate);
          played=true; playedRank=candidate;
          showDialogue(botName, botLinePlay(botName, need), 1600);
        }
      }

      if(!played && need===1 && ty.pile.rank==='JOKER'){
        for (var i4=0;i4<ty.hands[b].length;i4++){
          if(isThreeOfSpades(ty.hands[b][i4])){
            var jokerOwner = ty.pile.by;
            if(jokerOwner!=null && jokerOwner>=1 && jokerOwner<=3){
              var ownerName = ty.botNames[jokerOwner-1];
              showDialogue(ownerName, botLineJokered(ownerName), 1600);
            }
            triggerThreeSpadeSequence(b, ty.hands[b][i4]);
            return;
          }
        }
      }

      if(!played && ty.pile.rank!=='JOKER' && (counts['JOKER']||0) >= need){
        var js=[], jn=0;
        for (var j2=0;j2<ty.hands[b].length && jn<need;j2++){ if(isJoker(ty.hands[b][j2])){ js.push(ty.hands[b][j2]); jn++; } }
        if(maybePreCutinThenPlay(js, 'JOKER')){ return; }
        if(canPlayCardsAgainstPile(js)){
          ty_botPlayExact(b, js, 'JOKER');
          played=true; playedRank='JOKER';
          showDialogue(botName, botLinePlay(botName, need), 1600);
        }
      }
    }

    if(!played){
      passAdd(b);
      showDialogue(botName, botLinePass(botName), 1500);

      if(resolveAllPassIfNeeded()){ ty_updateButtons(); return; }

      ty.turn=nextAlive(b);
      ty_updateButtons();
      if(!isRoundOver() && ty.turn!==0) ty_queueNextStep(BOT_TURN_DELAY); else if(isRoundOver()) scheduleFinishRound();
    } else {
      handleSpecialsThenProceed(ty.pile.cards || [], playedRank);
    }
  } finally {
    ty._stepping=false;
  }
}

/* Direction mapping: CPU1=left, CPU2=top, CPU3=right, Player=bottom */
function ty_botPlayExact(botIndex, cards, effRank){
  if(ty.pile.count>0 && cards.length!==ty.pile.count) return;
  var dir = dirForIndex(botIndex);
  var idset = {}; for(var i=0;i<cards.length;i++){ idset[cards[i].id]=true; }
  var remain=[]; for (var j=0;j<ty.hands[botIndex].length;j++){ var c=ty.hands[botIndex][j]; if(!idset[c.id]) remain.push(c); }
  ty.hands[botIndex]=remain;
  ty_setPile(botIndex, effRank, cards, dir);
}

/* Cut-in utility */
function showCutIn(imageUrl, duration, after){
  if(!el.cutin) { if(typeof after==='function') after(); return; }
  try{
    el.cutin.style.backgroundImage = "url('"+imageUrl+"')";
    el.cutin.classList.remove('hide');
    el.cutin.style.display = 'flex';
    void el.cutin.offsetHeight;
    el.cutin.classList.add('show');
    setTimeout(function(){
      el.cutin.classList.remove('show');
      el.cutin.classList.add('hide');
      setTimeout(function(){
        el.cutin.style.display = 'none';
        el.cutin.classList.remove('hide');
        if(typeof after==='function') after();
      }, 260);
    }, Math.max(600, duration|0));
  } catch(e){
    if(typeof after==='function') after();
  }
}

/* Round flow */
function objectHasKeys(o){ if(!o) return false; for(var k in o){ if(o.hasOwnProperty(k)) return true; } return false; }

function startRound(){
  hideTitle();
  if (el.setupModal) el.setupModal.style.display='none';
  if (el.resultsModal) el.resultsModal.style.display='none';
  setModalOpen(false);

  clearTimeout(ty._endTimer); ty.endingRound = false;

  ty.deck = buildDeck(); shuffle(ty.deck);
  ty.hands = [[],[],[],[]]; ty.finished=[false,false,false,false];
  ty.finishOrder=[]; ty.lastAction=['','','','']; ty.lastCards=[[],[],[],[]];
  ty.pile={rank:null,count:0,by:null,cards:[]}; ty.pileHistory=[]; passClear();
  ty.pileAnglesCurrent=[]; ty.pileAnglesHistory=[];
  ty.pileOffsetCurrent={x:0,y:0}; ty.pileOffsetHistory=[];
  ty.pileFanStepCurrent=0; ty.pileFanStepHistory=[];
  selClear(); ty.selectedRank=null; ty._inEightStop=false; ty._resolvingAllPass=false; ty._inReversal=false; ty._inRevolution=false; ty._inWinCutin=false;
  ty._anim.active=false; ty.revOrder=false; ty._revoIconDeferred=false;

  var per = Math.floor(ty.deck.length/4);
  for(var i=0;i<per;i++){ for(var p=0;p<4;p++){ ty.hands[p].push(ty.deck[i*4+p]); } }
  for(var pp=0;pp<4;pp++){ ty.hands[pp].sort(function(a,b){ return a.value-b.value || a.suit.localeCompare(b.suit); }); }

  if (match.roundsPlayed === 0 && (!ty.currentRoles || !objectHasKeys(ty.currentRoles))) {
    ty.currentRoles = { 0:'Commoner', 1:'Commoner', 2:'Commoner', 3:'Commoner' };
  }

  ty.turn=0; ty.started=true;
  updateHeaderControls();
  updateRevolutionIcon();

  updateRoundIndicator();
  ty_renderAll(true);
  syncLayout();
  ty_enterPlayerTurn();
  ty_updateButtons();
}

function scheduleFinishRound(){
  if(ty.endingRound) return;
  ty.endingRound=true;
  ty._endTimer = setTimeout(finishRoundAndScore, 50);
}

function finishRoundAndScore(){
  try{
    if(ty._timer){ clearTimeout(ty._timer); ty._timer=null; }
    if(ty._watch){ clearTimeout(ty._watch); ty._watch=null; }
    ty.currentRoles = {};
    for (var i=0;i<ty.finishOrder.length;i++){ var p=ty.finishOrder[i]; match.points[p] += RANK_POINTS[i]; ty.currentRoles[p] = RANK_NAMES[i]; }
    if (ty.finishOrder.length===3){ for(var last=0; last<4; last++){ if(ty.finishOrder.indexOf(last)===-1){ ty.finishOrder.push(last); break; } } }
    match.roundsPlayed += 1;
    var done = match.roundsPlayed >= match.totalRounds;

    var g=el.gamesetOverlay;

    function showGameSetThenResults(preDelay){
      var proceed = function(){
        try {
          renderLeaderboardImage();
          el.proceedBtn.style.display = done ? 'none' : 'inline-block';
          el.newMatchBtn.style.display = 'inline-block';
          el.closeLbBtn.style.display = done ? 'none' : 'inline-block';
          openResults();
        } catch(e2){
          openResults();
        }
      };
      if(g){
        setTimeout(function(){
          g.style.display='flex';
          setTimeout(function(){
            g.style.display='none';
            proceed();
          }, 1000);
        }, Math.max(0, preDelay|0));
      } else {
        proceed();
      }
    }

    var beggarIdx = -1, tycoonIdx = -1;
    for (var p=0;p<4;p++){
      if(ty.currentRoles[p]==='Beggar'){ beggarIdx = p; }
      if(ty.currentRoles[p]==='Tycoon'){ tycoonIdx = p; }
    }

    var didCutin = false;

    if (beggarIdx===0 && !didCutin){
      didCutin = true;
      setTimeout(function(){
        showCutIn(getCutinPath('You','upset'), CUTIN_DURATION_NEG, function(){ showGameSetThenResults(0); });
      }, CUTIN_APPEAR_DELAY_NEG);
    } else if (beggarIdx>=1 && beggarIdx<=3 && !didCutin){
      var nameNeg = ty.botNames[beggarIdx-1];
      didCutin = true;
      setTimeout(function(){
        showDialogue(nameNeg, botLineBeggar(nameNeg), 1800);
        showCutIn(getCutinPath(nameNeg,'upset'), CUTIN_DURATION_NEG, function(){ showGameSetThenResults(0); });
      }, CUTIN_APPEAR_DELAY_NEG);
    }

    if (!didCutin && tycoonIdx===0){
      didCutin = true;
      showCutIn(getCutinPath('You','happy'), CUTIN_DURATION_POS, function(){ showGameSetThenResults(0); });
    } else if (!didCutin && tycoonIdx>=1 && tycoonIdx<=3){
      var namePos = ty.botNames[tycoonIdx-1];
      didCutin = true;
      showCutIn(getCutinPath(namePos,'happy'), CUTIN_DURATION_POS, function(){ showGameSetThenResults(0); });
    }

    if(!didCutin){
      showGameSetThenResults(GAMESET_PRE_DELAY);
    }

  } catch(e){
    openResults();
  }
}

/* Leaderboard render */
function renderLeaderboardImage(){
  var entries = [
    { name:'You', idx:0, pts:match.points[0] },
    { name:ty.botNames[0], idx:1, pts:match.points[1] },
    { name:ty.botNames[1], idx:2, pts:match.points[2] },
    { name:ty.botNames[2], idx:3, pts:match.points[3] }
  ];
  entries.sort(function(a,b){ return b.pts-a.pts; });

  for(var i=0;i<4;i++){
    var slot = el.lbSlots[i];
    var label = el.lbScores[i];
    var ent = entries[i];
    if(!slot || !label || !ent) continue;
    var map = window.CUSTOM_ICONS || {};
    slot.src = ent.idx===0 ? './img/Player.png' : (map[ent.name] || '');
    slot.alt = (i+1) + ' — ' + ent.name;
    label.textContent = ent.pts + ' pts';
  }
}

/* Layout */
function syncLayout(){
  var strip = el.oppStrip; var w = (strip && strip.clientWidth) ? strip.clientWidth : window.innerWidth;
  var size = Math.round(w / 7.9);
  size = Math.max(160, Math.min(188, size));
  if (window.innerWidth < 680) size = Math.max(128, Math.min(164, Math.round(w / 8.3)));
  var i;
  for(i=0;i<el.opp.length;i++){
    var left = el.opp[i].icon.parentElement;
    if(left) left.style.setProperty('--icon-size', size + 'px');
  }
}

/* Header controls visibility (hide Start while playing) */
function updateHeaderControls(){
  try{
    if(!el.startBtn) return;
    el.startBtn.style.display = ty.started ? 'none' : 'inline-block';
  }catch(e){}
}

/* ========== Setup (Character Select) ========== */
function updateSetupStatus(){
  var n = setupState.selected.length;
  if (el.setupStart){ el.setupStart.disabled = (n !== 3); }
}
function clearSetupSelection(){
  setupState.selected = [];
  var tiles = toArray(el.ptGrid.querySelectorAll('.pt-icon-tile.sel'));
  for (var i=0;i<tiles.length;i++){ tiles[i].classList.remove('sel'); tiles[i].setAttribute('aria-selected','false'); }
  updateSetupStatus();
}
function toggleTileSelection(tile){
  if(!tile) return;
  var name = tile.getAttribute('data-name');
  if(!name) return;
  var idx = setupState.selected.indexOf(name);
  if (idx !== -1){
    setupState.selected.splice(idx,1);
    tile.classList.remove('sel');
    tile.setAttribute('aria-selected','false');
  } else {
    if (setupState.selected.length >= 3) return;
    setupState.selected.push(name);
    tile.classList.add('sel');
    tile.setAttribute('aria-selected','true');
  }
  updateSetupStatus();
}
function buildOpponentGrid(){
  el.ptGrid.innerHTML = '';
  var map=window.CUSTOM_ICONS||{};
  for(var i=0;i<PHANTOM_THIEVES.length;i++){
    var p=PHANTOM_THIEVES[i];
    var url=map[p.label]||'';
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'pt-icon-tile';
    btn.setAttribute('data-name', p.label);
    btn.setAttribute('role', 'option');
    btn.setAttribute('aria-selected', 'false');
    btn.tabIndex = 0;

    var img=document.createElement('img');
    img.className='img';
    img.alt=p.label;
    img.src=url || '';
    img.onerror = function(){
      this.style.display='none';
      var fb=document.createElement('div');
      fb.textContent=this.alt?this.alt[0]:'?';
      fb.style='font-size:42px;font-weight:900;color:#fff;';
      if(this.parentElement) this.parentElement.appendChild(fb);
    };
    btn.appendChild(img);
    el.ptGrid.appendChild(btn);
  }
  updateSetupStatus();
}
function bindSetupListenersOnce(){
  if (setupState.listenersBound) return;
  setupState.listenersBound = true;

  el.ptGrid.addEventListener('click', function(ev){
    var t = ev.target;
    while (t && t !== el.ptGrid && !t.classList.contains('pt-icon-tile')) t = t.parentElement;
    if (t && t.classList && t.classList.contains('pt-icon-tile')){
      ev.preventDefault(); ev.stopPropagation();
      toggleTileSelection(t);
    }
  }, false);

  el.ptGrid.addEventListener('keydown', function(ev){
    var key = ev.key || ev.keyCode;
    if(key==='Enter' || key===' ' || key===13 || key===32){
      var t = ev.target;
      if (t && t.classList && t.classList.contains('pt-icon-tile')){
        ev.preventDefault(); ev.stopPropagation();
        toggleTileSelection(t);
      }
    }
  }, false);

  if (el.setupClear){
    el.setupClear.addEventListener('click', function(){ clearSetupSelection(); });
  }

  if (el.setupStart){
    el.setupStart.addEventListener('click', function(){
      if (setupState.selected.length !== 3) return;
      ty.botNames = setupState.selected.slice(0,3);
      for(var j=0;j<3;j++){ setIcon(el.opp[j].icon, ty.botNames[j]); }
      closeSetup();
      match.roundsPlayed=0; match.points=[0,0,0,0]; ty.currentRoles={};
      updateRoundIndicator();
      startRound();
    });
  }
}

function openSetup(){
  hideTitle();
  setModalOpen(true);
  setupState.selected = [];
  buildOpponentGrid();
  bindSetupListenersOnce();
  updateSetupStatus();
  if (el.setupStart) el.setupStart.disabled = true;
  el.setupModal.style.display='flex';
}
function closeSetup(){ el.setupModal.style.display='none'; setModalOpen(false); }
/* ===================== End Setup ===================== */

/* Rules modal */
function openRules(){ setModalOpen(true); el.rulesModal.style.display='flex'; el.playerRoleImg.style.display='none'; }
function closeRules(){ el.rulesModal.style.display='none'; setModalOpen(false); }

/* Title helpers — auto show on boot */
function showTitle(){ if(el.titleScreen){ el.titleScreen.style.display='flex'; setModalOpen(true); } }
function hideTitle(){ if(el.titleScreen){ el.titleScreen.style.display='none'; setModalOpen(false); } }

/* Overlay image fallbacks */
function setupOverlayFallbacks(){
  var pairs = [
    { id:'img-8stop', primary:'./assets/8Stop.png', fallback:'./assets/8Stop.png' },
    { id:'img-allpass', primary:'./assets/AllPass.png', fallback:'./assets/AllPass.png' },
    { id:'img-gameset', primary:'./assets/GameSet.png', fallback:'./assets/GameSet.png' },
    { id:'img-reversal', primary:'./assets/3spadereverse.png', fallback:'./assets/3spadereverse.png' },
    { id:'img-revolution', primary:'./assets/revolution.png', fallback:'./assets/revolution.png' }
  ];
  for (var i=0;i<pairs.length;i++){
    (function(p){
      var img = document.getElementById(p.id);
      if (!img) return;
      img.onerror = function(){
        if (img.dataset.fallbackApplied === '1') return;
        img.dataset.fallbackApplied = '1';
        img.src = p.fallback;
      };
    })(pairs[i]);
  }
}

/* Wiring */
document.getElementById('ty-rules-btn').addEventListener('click', openRules);

/* Start buttons */
function handleStartClick(){
  if(ty.started) return;
  showTitle();
}
el.startBtn.addEventListener('click', handleStartClick);
if (el.titleStartBtn) el.titleStartBtn.addEventListener('click', function(){ openSetup(); });

el.rulesClose.addEventListener('click', closeRules);
document.getElementById('rules-modal').addEventListener('click', function(e){ if(e.target===document.getElementById('rules-modal')) closeRules(); });

/* Gameplay buttons */
el.playBtn.addEventListener('click', function(){
  if(ty_canPlaySelection()){ ty_playSelected(); }
  ty_updateButtons();
});
el.passBtn.addEventListener('click', function(){ ty_pass(); ty_updateButtons(); });

/* Results controls */
el.proceedBtn.addEventListener('click', function(){ closeResults(); startRound(); });
el.newMatchBtn.addEventListener('click', function(){
  closeResults();
  match.roundsPlayed=0; match.points=[0,0,0,0];
  ty.started=false;
  updateHeaderControls();
  ty.pile={rank:null,count:0,by:null,cards:[]}; ty.pileHistory=[];
  ty.pileAnglesCurrent=[]; ty.pileAnglesHistory=[];
  ty.pileOffsetCurrent={x:0,y:0}; ty.pileOffsetHistory=[];
  ty.pileFanStepCurrent=0; ty.pileFanStepHistory=[];
  openSetup();
});
el.closeLbBtn.addEventListener('click', function(){ closeResults(); });

/* Results modal helpers */
function sizeLeaderboard(){
  var board = el.resultsBoard;
  var actions = document.querySelector('#results-modal .lb-actions');
  if(!board) return;

  var vw = Math.max(320, window.innerWidth || document.documentElement.clientWidth || 0);
  var vh = Math.max(320, window.innerHeight || document.documentElement.clientHeight || 0);

  var barH = 0;
  if (actions){
    var r = actions.getBoundingClientRect();
    barH = Math.max(64, Math.round(r.height + 18));
  }

  var topMargin = 12;
  var availH = Math.max(120, vh - barH - topMargin);

  var widthBased = Math.round(vw * 0.96);
  var heightBased = Math.round(availH * 16 / 9 * 1.8);
  var targetW = Math.max(widthBased, heightBased);
  var maxW = Math.round(vw * 1.6);
  targetW = Math.min(targetW, maxW);

  board.style.setProperty('width', targetW + 'px', 'important');
  board.style.setProperty('height', 'auto', 'important');
  board.style.setProperty('aspect-ratio', '16 / 9', 'important');

  var iconPx = Math.round(targetW * 0.10);
  iconPx = Math.max(90, Math.min(160, iconPx));
  board.style.setProperty('--lb-icon-size', iconPx + 'px');

  function _computeShiftRatio(vw, vh){
    var ar = vw / Math.max(vh, 1);
    if (ar <= 0.9) return -0.160;
    if (ar <= 1.1) return -0.145;
    if (ar <= 1.4) return -0.130;
    if (ar <= 1.8) return -0.115;
    if (ar <= 2.2) return -0.105;
    return -0.100;
  }
  var ratio = _computeShiftRatio(vw, vh);
  var shiftPx = Math.round(targetW * ratio);
  board.style.setProperty('--lb-shift', shiftPx + 'px');
}
var _lbResizeHandler = null;
function openResults(){
  setModalOpen(true);
  el.resultsModal.style.display='flex';
  sizeLeaderboard();
  requestAnimationFrame(sizeLeaderboard);
  if(_lbResizeHandler){ window.removeEventListener('resize', _lbResizeHandler); }
  _lbResizeHandler = function(){ sizeLeaderboard(); };
  window.addEventListener('resize', _lbResizeHandler);
}
function closeResults(){
  el.resultsModal.style.display='none';
  if(_lbResizeHandler){ window.removeEventListener('resize', _lbResizeHandler); _lbResizeHandler=null; }
  setModalOpen(false);
}

/* Modal helper */
function setModalOpen(flag){
  try{
    document.documentElement.classList.toggle('modal-open', !!flag);
    document.body.classList.toggle('modal-open', !!flag);
  }catch(e){}
}

/* Resizing */
window.addEventListener('resize', function(){ layoutFanHandFlat(); syncLayout(); });

/* Boot */
function boot(){
  try {
    updateRoundIndicator();
    for(var i=0;i<3;i++){ setIcon(el.opp[i].icon, ty.botNames[i]); }
    setupOverlayFallbacks();
    ty_renderAll(true);
  } catch(e){ }
  ty.started = false; updateHeaderControls(); updateRevolutionIcon();
  showTitle();
}
if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
</script>

<!-- Service worker registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){
    navigator.serviceWorker.register('./service-worker.js').catch(function(){});
  });
}
</script>
</body>
</html>